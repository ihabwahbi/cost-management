(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[895],{94139:function(e,t,s){Promise.resolve().then(s.bind(s,79584))},79584:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return ti}});var a=s(2562),r=s(53121),n=s(62680),i=s(34020),l=s(4443),o=s(47894),c=s(37754),d=s(90106),u=s(60204),m=s(71202);let x={pending:{color:"bg-yellow-100 text-yellow-800 border-yellow-300",icon:l.Z,label:"Pending"},saved:{color:"bg-green-100 text-green-800 border-green-300",icon:o.Z,label:"Saved"},error:{color:"bg-red-100 text-red-800 border-red-300",icon:c.Z,label:"Error"},syncing:{color:"bg-blue-100 text-blue-800 border-blue-300",icon:d.Z,label:"Syncing"},staged:{color:"bg-amber-100 text-amber-800 border-amber-300",icon:u.Z,label:"Staged"},modified:{color:"bg-indigo-100 text-indigo-800 border-indigo-300",icon:u.Z,label:"Modified"}};function h(e){let{id:t,modified:s=!1,saving:r=!1,error:n=!1}=e,l=null==t?void 0:t.startsWith("temp_"),o="saved";n?o="error":r?o="syncing":l?o="staged":s&&(o="modified");let c=x[o],d=c.icon;return"string"==typeof n||c.label,(0,a.jsxs)(i.C,{variant:"outline",className:(0,m.cn)(c.color,r&&"animate-pulse","transition-all duration-200"),title:"error"===o&&"string"==typeof n?n:void 0,children:[(0,a.jsx)(d,{className:(0,m.cn)("w-3 h-3 mr-1","syncing"===o&&"animate-spin")}),"error"===o&&"string"==typeof n?"Error":c.label]})}var g=s(22698),p=s(31178),f=s(61997);function b(e){let{count:t,onSave:s,onDiscard:r}=e;return 0===t?null:(0,a.jsxs)("div",{className:"fixed bottom-4 right-4 z-50 bg-amber-100 border-2 border-amber-300 rounded-lg shadow-lg p-4 max-w-sm",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)(u.Z,{className:"w-5 h-5 text-amber-600 flex-shrink-0"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("p",{className:"text-sm font-medium text-amber-900",children:[t," unsaved ",1===t?"change":"changes"]}),(0,a.jsx)("p",{className:"text-xs text-amber-700 mt-1",children:"Your changes will be lost if you leave"})]})]}),(0,a.jsxs)("div",{className:"flex gap-2 mt-3",children:[(0,a.jsxs)(f.z,{size:"sm",onClick:s,className:"flex-1 bg-amber-600 hover:bg-amber-700",children:[(0,a.jsx)(g.Z,{className:"w-3 h-3 mr-1"}),"Save All"]}),(0,a.jsxs)(f.z,{size:"sm",variant:"outline",onClick:r,className:"flex-1",children:[(0,a.jsx)(p.Z,{className:"w-3 h-3 mr-1"}),"Discard"]})]})]})}var v=s(23980);function j(e){let{...t}=e;return(0,a.jsx)(v.fC,{"data-slot":"dialog",...t})}function y(e){let{...t}=e;return(0,a.jsx)(v.xz,{"data-slot":"dialog-trigger",...t})}function N(e){let{...t}=e;return(0,a.jsx)(v.h_,{"data-slot":"dialog-portal",...t})}let _=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,a.jsx)(v.aV,{ref:t,"data-slot":"dialog-overlay",className:(0,m.cn)("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",s),...r})});function w(e){let{className:t,children:s,showCloseButton:r=!0,...n}=e;return(0,a.jsxs)(N,{"data-slot":"dialog-portal",children:[(0,a.jsx)(_,{}),(0,a.jsxs)(v.VY,{"data-slot":"dialog-content",className:(0,m.cn)("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",t),...n,children:[s,r&&(0,a.jsxs)(v.x8,{"data-slot":"dialog-close",className:"ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",children:[(0,a.jsx)(p.Z,{}),(0,a.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})}function C(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"dialog-header",className:(0,m.cn)("flex flex-col gap-2 text-center sm:text-left",t),...s})}function S(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"dialog-footer",className:(0,m.cn)("flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",t),...s})}function k(e){let{className:t,...s}=e;return(0,a.jsx)(v.Dx,{"data-slot":"dialog-title",className:(0,m.cn)("text-lg leading-none font-semibold",t),...s})}function E(e){let{className:t,...s}=e;return(0,a.jsx)(v.dk,{"data-slot":"dialog-description",className:(0,m.cn)("text-muted-foreground text-sm",t),...s})}_.displayName=v.aV.displayName;var D=s(66237),P=s(10516),F=s(56092),z=s(90033),I=s(8393);function Z(e){let{className:t,children:s,...r}=e;return(0,a.jsxs)(I.fC,{"data-slot":"scroll-area",className:(0,m.cn)("relative",t),...r,children:[(0,a.jsx)(I.l_,{"data-slot":"scroll-area-viewport",className:"focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1",children:s}),(0,a.jsx)(A,{}),(0,a.jsx)(I.Ns,{})]})}function A(e){let{className:t,orientation:s="vertical",...r}=e;return(0,a.jsx)(I.gb,{"data-slot":"scroll-area-scrollbar",orientation:s,className:(0,m.cn)("flex touch-none p-px transition-colors select-none","vertical"===s&&"h-full w-2.5 border-l border-l-transparent","horizontal"===s&&"h-2.5 flex-col border-t border-t-transparent",t),...r,children:(0,a.jsx)(I.q4,{"data-slot":"scroll-area-thumb",className:"bg-border relative flex-1 rounded-full"})})}var L=s(23482);function O(e){let{className:t,type:s,...r}=e;return(0,a.jsx)("input",{type:s,"data-slot":"input",className:(0,m.cn)("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]","aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",t),...r})}var T=s(77726),M=s(55107),V=s(33651),B=s(63757),U=s(50248),R=s(23166),q=s(672),Y=s(65042),W=s(29976),K=s(20559),Q=s(12573),$=s(48166),X=s(17215),G=s(71921);let H=["M&S","Services","Equipment","Labor","Contractors","Consumables"],J=["Operational","Maintenance","Capital","Emergency","Planned"],ee=["WIS","Drilling","Production","Facilities","Subsea","FPSO"];function et(e){let{isOpen:t,onClose:s,projectId:n,projectName:l,currentCosts:o,stagedEntries:c,onSave:d,onAddEntry:m,onUpdateEntry:x,onDeleteEntry:h}=e,[p,b]=(0,r.useState)("review"),[v,y]=(0,r.useState)({}),[N,_]=(0,r.useState)([]),[I,A]=(0,r.useState)(""),[et,es]=(0,r.useState)(!1),[ea,er]=(0,r.useState)(null),[en,ei]=(0,r.useState)(!1),[el,eo]=(0,r.useState)({sub_business_line:ee[0],cost_line:"",spend_type:"",spend_sub_category:"",budget_cost:0});(0,r.useEffect)(()=>{_(c)},[c]),(0,r.useEffect)(()=>{let e={projectId:n,forecastChanges:v,localStagedEntries:N,forecastReason:I,currentStep:p,timestamp:new Date().toISOString()};localStorage.setItem("forecast-draft-".concat(n),JSON.stringify(e))},[n,v,N,I,p]),(0,r.useEffect)(()=>{let e="forecast-draft-".concat(n),t=localStorage.getItem(e);if(t)try{let e=JSON.parse(t);Date.now()-new Date(e.timestamp).getTime()<864e5&&(y(e.forecastChanges||{}),_(e.localStagedEntries||[]),A(e.forecastReason||""))}catch(e){console.error("Error loading draft:",e)}},[n]);let ec=[{key:"review",label:"Review Budget",icon:(0,a.jsx)(V.Z,{className:"w-4 h-4"})},{key:"modify",label:"Modify Assumptions",icon:(0,a.jsx)(B.Z,{className:"w-4 h-4"})},{key:"add-reason",label:"Add Reason",icon:(0,a.jsx)(U.Z,{className:"w-4 h-4"})},{key:"preview",label:"Preview Changes",icon:(0,a.jsx)(R.Z,{className:"w-4 h-4"})},{key:"confirm",label:"Confirm & Save",icon:(0,a.jsx)(g.Z,{className:"w-4 h-4"})}],ed=ec.findIndex(e=>e.key===p),eu=(ed+1)/ec.length*100,em=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),ex=()=>o.reduce((e,t)=>e+t.budget_cost,0),eh=()=>o.reduce((e,t)=>{let s=v[t.id];return e+(void 0!==s?s:t.budget_cost)},0)+N.reduce((e,t)=>e+t.budget_cost,0),eg=()=>eh()-ex(),ep=()=>{let e=ex();return 0===e?0:eg()/e*100},ef=()=>Object.keys(v).length+N.length,eb=async()=>{es(!0);try{await d(v,N,I),localStorage.removeItem("forecast-draft-".concat(n)),y({}),_([]),A(""),b("review"),s()}catch(e){console.error("Error saving forecast:",e)}finally{es(!1)}},ev=()=>{if(el.cost_line&&el.spend_type&&el.spend_sub_category&&el.budget_cost){let e="temp_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9));_([...N,{id:e,project_id:n,sub_business_line:el.sub_business_line||ee[0],cost_line:el.cost_line,spend_type:el.spend_type,spend_sub_category:el.spend_sub_category,budget_cost:el.budget_cost,_tempId:e}]),eo({sub_business_line:ee[0],cost_line:"",spend_type:"",spend_sub_category:"",budget_cost:0}),ei(!1)}},ej=e=>{_(N.filter(t=>t.id!==e))},ey=()=>{switch(p){case"review":case"preview":case"confirm":return!0;case"modify":return ef()>0;case"add-reason":return I.trim().length>0;default:return!1}};return(0,a.jsx)(j,{open:t,onOpenChange:s,children:(0,a.jsxs)(w,{className:"max-w-6xl w-[95vw] h-[90vh] flex flex-col overflow-hidden",children:[(0,a.jsxs)(C,{className:"flex-shrink-0",children:[(0,a.jsxs)(k,{children:["Create New Forecast - ",l]}),(0,a.jsx)(E,{children:"Follow the steps to create a new forecast version with tracked changes"})]}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col min-h-0",children:[(0,a.jsxs)("div",{className:"space-y-2 flex-shrink-0 pb-4",children:[(0,a.jsx)(F.E,{value:eu,className:"h-2"}),(0,a.jsx)("div",{className:"flex justify-between",children:ec.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center gap-1 text-xs ".concat(t<=ed?"text-primary font-medium":"text-muted-foreground"),children:[t<=ed?(0,a.jsx)(Q.Z,{className:"w-3 h-3"}):(0,a.jsx)($.Z,{className:"w-3 h-3"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:e.label})]},e.key))})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto min-h-0",children:(()=>{switch(p){case"review":return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)(z.bZ,{children:[(0,a.jsx)(u.Z,{className:"h-4 w-4"}),(0,a.jsx)(z.X,{children:"Review the current budget before making modifications. This will be your baseline for the forecast."})]}),(0,a.jsxs)(D.Zb,{children:[(0,a.jsx)(D.Ol,{children:(0,a.jsx)(D.ll,{className:"text-lg",children:"Current Budget Summary"})}),(0,a.jsx)(D.aY,{children:(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Total Budget"}),(0,a.jsx)("p",{className:"text-2xl font-bold",children:em(ex())})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Line Items"}),(0,a.jsx)("p",{className:"text-2xl font-bold",children:o.length})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Last Updated"}),(0,a.jsx)("p",{className:"text-2xl font-bold",children:"Current"})]})]})})]}),(0,a.jsx)(Z,{className:"h-[300px]",children:(0,a.jsxs)(L.iA,{children:[(0,a.jsx)(L.xD,{children:(0,a.jsxs)(L.SC,{children:[(0,a.jsx)(L.ss,{children:"Cost Line"}),(0,a.jsx)(L.ss,{children:"Type"}),(0,a.jsx)(L.ss,{children:"Sub Category"}),(0,a.jsx)(L.ss,{className:"text-right",children:"Amount"})]})}),(0,a.jsx)(L.RM,{children:o.map(e=>(0,a.jsxs)(L.SC,{children:[(0,a.jsx)(L.pj,{children:e.cost_line}),(0,a.jsx)(L.pj,{children:e.spend_type}),(0,a.jsx)(L.pj,{children:e.spend_sub_category}),(0,a.jsx)(L.pj,{className:"text-right",children:em(e.budget_cost)})]},e.id))})]})})]});case"modify":return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)(z.bZ,{children:[(0,a.jsx)(B.Z,{className:"h-4 w-4"}),(0,a.jsx)(z.X,{children:"Modify budget amounts or add new cost items. All changes will be tracked in the forecast version."})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"Cost Items"}),!en&&(0,a.jsxs)(f.z,{size:"sm",variant:"outline",onClick:()=>ei(!0),children:[(0,a.jsx)(q.Z,{className:"w-4 h-4 mr-2"}),"Add New Entry"]})]}),en&&(0,a.jsxs)(D.Zb,{className:"border-blue-200 bg-blue-50/50",children:[(0,a.jsx)(D.Ol,{children:(0,a.jsx)(D.ll,{className:"text-sm",children:"Add New Cost Entry"})}),(0,a.jsxs)(D.aY,{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(T._,{children:"Sub Business Line"}),(0,a.jsxs)(M.Ph,{value:el.sub_business_line,onValueChange:e=>eo({...el,sub_business_line:e}),children:[(0,a.jsx)(M.i4,{children:(0,a.jsx)(M.ki,{})}),(0,a.jsx)(M.Bw,{children:ee.map(e=>(0,a.jsx)(M.Ql,{value:e,children:e},e))})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(T._,{children:"Cost Line"}),(0,a.jsxs)(M.Ph,{value:el.cost_line,onValueChange:e=>eo({...el,cost_line:e}),children:[(0,a.jsx)(M.i4,{children:(0,a.jsx)(M.ki,{placeholder:"Select cost line"})}),(0,a.jsx)(M.Bw,{children:H.map(e=>(0,a.jsx)(M.Ql,{value:e,children:e},e))})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(T._,{children:"Spend Type"}),(0,a.jsxs)(M.Ph,{value:el.spend_type,onValueChange:e=>eo({...el,spend_type:e}),children:[(0,a.jsx)(M.i4,{children:(0,a.jsx)(M.ki,{placeholder:"Select spend type"})}),(0,a.jsx)(M.Bw,{children:J.map(e=>(0,a.jsx)(M.Ql,{value:e,children:e},e))})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(T._,{children:"Sub Category"}),(0,a.jsx)(O,{value:el.spend_sub_category,onChange:e=>eo({...el,spend_sub_category:e.target.value}),placeholder:"Enter sub category"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(T._,{children:"Budget Cost"}),(0,a.jsx)(O,{type:"number",value:el.budget_cost,onChange:e=>eo({...el,budget_cost:parseFloat(e.target.value)||0}),placeholder:"0.00"})]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(f.z,{size:"sm",onClick:ev,children:"Add Entry"}),(0,a.jsx)(f.z,{size:"sm",variant:"outline",onClick:()=>{ei(!1),eo({sub_business_line:ee[0],cost_line:"",spend_type:"",spend_sub_category:"",budget_cost:0})},children:"Cancel"})]})]})]}),(0,a.jsx)("div",{className:"relative border rounded-md flex-1 min-h-0",children:(0,a.jsx)("div",{className:"h-full max-h-[500px] overflow-auto",children:(0,a.jsxs)(L.iA,{className:"w-full min-w-[800px]",children:[(0,a.jsx)(L.xD,{className:"sticky top-0 bg-background z-10 border-b",children:(0,a.jsxs)(L.SC,{children:[(0,a.jsx)(L.ss,{className:"whitespace-nowrap",children:"Status"}),(0,a.jsx)(L.ss,{className:"whitespace-nowrap",children:"Cost Line"}),(0,a.jsx)(L.ss,{className:"whitespace-nowrap",children:"Type"}),(0,a.jsx)(L.ss,{className:"whitespace-nowrap",children:"Sub Category"}),(0,a.jsx)(L.ss,{className:"text-right whitespace-nowrap",children:"Original"}),(0,a.jsx)(L.ss,{className:"text-right whitespace-nowrap",children:"Forecast"}),(0,a.jsx)(L.ss,{className:"w-20"})]})}),(0,a.jsxs)(L.RM,{children:[o.map(e=>{var t;let s=ea===e.id,r=void 0!==v[e.id],n=null!==(t=v[e.id])&&void 0!==t?t:e.budget_cost;return(0,a.jsxs)(L.SC,{children:[(0,a.jsx)(L.pj,{className:"whitespace-nowrap",children:r&&(0,a.jsx)(i.C,{variant:"outline",className:"text-xs",children:"Modified"})}),(0,a.jsx)(L.pj,{className:"whitespace-nowrap",children:e.cost_line}),(0,a.jsx)(L.pj,{className:"whitespace-nowrap",children:e.spend_type}),(0,a.jsx)(L.pj,{className:"whitespace-nowrap truncate max-w-[150px]",title:e.spend_sub_category,children:e.spend_sub_category}),(0,a.jsx)(L.pj,{className:"text-right whitespace-nowrap",children:em(e.budget_cost)}),(0,a.jsx)(L.pj,{className:"text-right whitespace-nowrap p-1",children:s?(0,a.jsx)(O,{type:"number",value:n,onChange:t=>y({...v,[e.id]:parseFloat(t.target.value)||0}),className:"w-28 text-right text-sm",autoFocus:!0,onBlur:()=>er(null),onKeyDown:e=>{"Enter"===e.key&&er(null)}}):(0,a.jsx)("button",{onClick:()=>er(e.id),className:"hover:underline text-right w-full",children:em(n)})}),(0,a.jsx)(L.pj,{className:"p-1",children:r&&(0,a.jsx)(f.z,{size:"sm",variant:"ghost",className:"h-8 px-2 text-xs",onClick:()=>{let{[e.id]:t,...s}=v;y(s)},children:"Reset"})})]},e.id)}),N.map(e=>(0,a.jsxs)(L.SC,{className:"bg-amber-50/50",children:[(0,a.jsx)(L.pj,{className:"whitespace-nowrap",children:(0,a.jsx)(i.C,{className:"text-xs bg-amber-500",children:"New"})}),(0,a.jsx)(L.pj,{className:"whitespace-nowrap",children:e.cost_line}),(0,a.jsx)(L.pj,{className:"whitespace-nowrap",children:e.spend_type}),(0,a.jsx)(L.pj,{className:"whitespace-nowrap truncate max-w-[150px]",title:e.spend_sub_category,children:e.spend_sub_category}),(0,a.jsx)(L.pj,{className:"text-right whitespace-nowrap",children:"-"}),(0,a.jsx)(L.pj,{className:"text-right whitespace-nowrap",children:em(e.budget_cost)}),(0,a.jsx)(L.pj,{className:"p-1",children:(0,a.jsx)(f.z,{size:"sm",variant:"ghost",className:"h-8 px-2",onClick:()=>ej(e.id),children:(0,a.jsx)(Y.Z,{className:"w-3 h-3"})})})]},e.id))]})]})})}),(0,a.jsx)(D.Zb,{className:"bg-gray-50",children:(0,a.jsx)(D.aY,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("span",{className:"text-sm text-muted-foreground",children:["Total Changes: ",ef()," items"]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-sm text-muted-foreground",children:"New Total:"}),(0,a.jsx)("span",{className:"text-lg font-bold",children:em(eh())}),0!==eg()&&(0,a.jsxs)(i.C,{variant:eg()>0?"default":"destructive",className:"ml-2",children:[eg()>0?"+":"",em(eg())]})]})]})})})]});case"add-reason":return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)(z.bZ,{children:[(0,a.jsx)(U.Z,{className:"h-4 w-4"}),(0,a.jsx)(z.X,{children:"Provide a clear reason for this forecast. This will be stored with the version for future reference."})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(T._,{htmlFor:"reason",children:"Reason for Forecast"}),(0,a.jsx)(P.g,{id:"reason",value:I,onChange:e=>A(e.target.value),placeholder:"Explain the business rationale for these changes...",className:"min-h-[200px]"}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:'Be specific about what drove these changes (e.g., "Q3 market conditions require additional equipment maintenance budget")'})]}),(0,a.jsxs)(D.Zb,{children:[(0,a.jsx)(D.Ol,{children:(0,a.jsx)(D.ll,{className:"text-sm",children:"Change Summary"})}),(0,a.jsx)(D.aY,{children:(0,a.jsxs)("dl",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-muted-foreground",children:"Items Modified"}),(0,a.jsxs)("dd",{className:"font-semibold",children:[Object.keys(v).length," existing"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-muted-foreground",children:"Items Added"}),(0,a.jsxs)("dd",{className:"font-semibold",children:[N.length," new"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-muted-foreground",children:"Total Change"}),(0,a.jsxs)("dd",{className:"font-semibold",children:[eg()>0?"+":"",em(eg())]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("dt",{className:"text-muted-foreground",children:"Change %"}),(0,a.jsxs)("dd",{className:"font-semibold",children:[ep()>0?"+":"",ep().toFixed(1),"%"]})]})]})})]})]});case"preview":return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)(z.bZ,{children:[(0,a.jsx)(R.Z,{className:"h-4 w-4"}),(0,a.jsx)(z.X,{children:"Review all changes before saving. This will create a new forecast version."})]}),(0,a.jsxs)(D.Zb,{children:[(0,a.jsxs)(D.Ol,{children:[(0,a.jsx)(D.ll,{children:"Forecast Summary"}),(0,a.jsx)(D.SZ,{children:I})]}),(0,a.jsxs)(D.aY,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-semibold mb-2",children:"Before"}),(0,a.jsxs)("dl",{className:"space-y-1 text-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("dt",{className:"text-muted-foreground",children:"Total Budget"}),(0,a.jsx)("dd",{children:em(ex())})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("dt",{className:"text-muted-foreground",children:"Line Items"}),(0,a.jsx)("dd",{children:o.length})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-semibold mb-2",children:"After"}),(0,a.jsxs)("dl",{className:"space-y-1 text-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("dt",{className:"text-muted-foreground",children:"Total Forecast"}),(0,a.jsx)("dd",{className:"font-semibold",children:em(eh())})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("dt",{className:"text-muted-foreground",children:"Line Items"}),(0,a.jsx)("dd",{className:"font-semibold",children:o.length+N.length})]})]})]})]}),(0,a.jsx)("div",{className:"mt-4 pt-4 border-t",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[eg()>=0?(0,a.jsx)(W.Z,{className:"w-4 h-4 text-green-600"}):(0,a.jsx)(K.Z,{className:"w-4 h-4 text-red-600"}),(0,a.jsx)("span",{className:"font-semibold",children:"Total Change:"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("span",{className:"text-lg font-bold ".concat(eg()>=0?"text-green-600":"text-red-600"),children:[eg()>0?"+":"",em(eg())]}),(0,a.jsxs)(i.C,{variant:"outline",children:[ep()>0?"+":"",ep().toFixed(1),"%"]})]})]})})]})]}),Object.keys(v).length>0&&(0,a.jsxs)(D.Zb,{children:[(0,a.jsx)(D.Ol,{children:(0,a.jsx)(D.ll,{className:"text-sm",children:"Modified Items"})}),(0,a.jsx)(D.aY,{children:(0,a.jsx)(Z,{className:"h-[200px]",children:(0,a.jsx)("div",{className:"space-y-2",children:Object.entries(v).map(e=>{let[t,s]=e,r=o.find(e=>e.id===t);if(!r)return null;let n=s-r.budget_cost;return(0,a.jsxs)("div",{className:"flex justify-between items-center text-sm py-1",children:[(0,a.jsxs)("span",{className:"text-muted-foreground",children:[r.cost_line," - ",r.spend_sub_category]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:em(r.budget_cost)}),(0,a.jsx)("span",{children:"â†’"}),(0,a.jsx)("span",{className:"font-semibold",children:em(s)}),(0,a.jsxs)(i.C,{variant:n>0?"default":"destructive",className:"text-xs",children:[n>0?"+":"",em(n)]})]})]},t)})})})})]}),N.length>0&&(0,a.jsxs)(D.Zb,{children:[(0,a.jsx)(D.Ol,{children:(0,a.jsx)(D.ll,{className:"text-sm",children:"New Items"})}),(0,a.jsx)(D.aY,{children:(0,a.jsx)(Z,{className:"h-[200px]",children:(0,a.jsx)("div",{className:"space-y-2",children:N.map(e=>(0,a.jsxs)("div",{className:"flex justify-between items-center text-sm py-1",children:[(0,a.jsxs)("span",{className:"text-muted-foreground",children:[e.cost_line," - ",e.spend_sub_category]}),(0,a.jsx)("span",{className:"font-semibold",children:em(e.budget_cost)})]},e.id))})})})]})]});case"confirm":return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)(z.bZ,{className:"border-green-200 bg-green-50",children:[(0,a.jsx)(Q.Z,{className:"h-4 w-4 text-green-600"}),(0,a.jsx)(z.X,{className:"text-green-800",children:"Your forecast is ready to be saved. This will create a new version that can be reviewed and compared with previous versions."})]}),(0,a.jsx)(D.Zb,{children:(0,a.jsx)(D.aY,{className:"pt-6",children:(0,a.jsxs)("div",{className:"text-center space-y-4",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto",children:(0,a.jsx)(Q.Z,{className:"w-8 h-8 text-green-600"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"Ready to Save Forecast"}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground mt-1",children:["Version will be created with ",ef()," changes"]})]}),(0,a.jsxs)("div",{className:"pt-4 space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"New Total:"}),(0,a.jsx)("span",{className:"font-semibold",children:em(eh())})]}),(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"Change:"}),(0,a.jsxs)("span",{className:"font-semibold ".concat(eg()>=0?"text-green-600":"text-red-600"),children:[eg()>0?"+":"",em(eg())," (",ep()>0?"+":"",ep().toFixed(1),"%)"]})]}),(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"Reason:"}),(0,a.jsx)("span",{className:"font-semibold text-right max-w-[200px] truncate",children:I})]})]})]})})})]});default:return null}})()})]}),(0,a.jsxs)(S,{className:"flex justify-between flex-shrink-0 mt-4",children:[(0,a.jsx)("div",{className:"flex gap-2",children:ed>0&&(0,a.jsxs)(f.z,{variant:"outline",onClick:()=>{let e=ec.findIndex(e=>e.key===p);e>0&&b(ec[e-1].key)},disabled:et,children:[(0,a.jsx)(X.Z,{className:"w-4 h-4 mr-2"}),"Back"]})}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(f.z,{variant:"outline",onClick:s,disabled:et,children:"Cancel"}),"confirm"===p?(0,a.jsx)(f.z,{onClick:eb,disabled:et||!ey(),children:et?"Saving...":"Save Forecast"}):(0,a.jsxs)(f.z,{onClick:()=>{let e=ec.findIndex(e=>e.key===p);e<ec.length-1&&b(ec[e+1].key)},disabled:!ey(),children:["Next",(0,a.jsx)(G.Z,{className:"w-4 h-4 ml-2"})]})]})]})]})})}var es=s(92723),ea=s(38526),er=s(42185),en=s(98076),ei=s(19765);function el(e){let{versions:t,currentVersion:s,onVersionSelect:n,onCompareVersions:o,costBreakdowns:c,isLoading:d}=e,[u,m]=(0,r.useState)(!1),[x,h]=(0,r.useState)(null),[g,p]=(0,r.useState)(null),[b,v]=(0,r.useState)(null),y=[...t].sort((e,t)=>t.version_number-e.version_number),N=e=>{let t=Date.now()-new Date(e.created_at).getTime();return t<864e5?{label:"New",variant:"default"}:t<6048e5?{label:"Recent",variant:"secondary"}:t<2592e6?{label:"Current",variant:"outline"}:{label:"Historical",variant:"outline"}},_=e=>{if(!c||0===e)return{totalChange:0,changePercent:0,itemsChanged:0};let t=c[e]||[],s=c[e-1]||[],a=0,r=0;t.forEach(e=>{let t=s.find(t=>t.id===e.id);if(t){let s=(e.forecasted_cost||e.budget_cost)-(t.forecasted_cost||t.budget_cost);0!==s&&(a+=s,r++)}else a+=e.forecasted_cost||e.budget_cost,r++});let n=s.reduce((e,t)=>e+(t.forecasted_cost||t.budget_cost),0),i=n>0?a/n*100:0;return{totalChange:a,changePercent:i,itemsChanged:r}},S=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e);return d?(0,a.jsx)(D.Zb,{children:(0,a.jsx)(D.aY,{className:"p-6",children:(0,a.jsxs)("div",{className:"animate-pulse space-y-4",children:[(0,a.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/3"}),(0,a.jsx)("div",{className:"h-20 bg-gray-200 rounded"}),(0,a.jsx)("div",{className:"h-20 bg-gray-200 rounded"})]})})}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(D.Zb,{children:[(0,a.jsx)(D.Ol,{children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(D.ll,{children:"Version History"}),(0,a.jsx)(D.SZ,{children:"Track changes and evolution of budget assumptions"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(f.z,{variant:"outline",size:"sm",onClick:()=>m(!0),disabled:t.length<2,children:[(0,a.jsx)(ea.Z,{className:"w-4 h-4 mr-2"}),"Compare"]}),(0,a.jsxs)(f.z,{variant:"outline",size:"sm",onClick:()=>{},children:[(0,a.jsx)(er.Z,{className:"w-4 h-4 mr-2"}),"Export"]})]})]})}),(0,a.jsx)(D.aY,{children:(0,a.jsx)(Z,{className:"h-[500px] pr-4",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"absolute left-9 top-0 bottom-0 w-0.5 bg-gray-200"}),y.map((e,t)=>{let r=_(e.version_number),o=N(e),d=s===e.version_number||"latest"===s&&0===t,u=b===e.id;return(0,a.jsxs)("div",{className:"relative flex gap-4 pb-8",children:[(0,a.jsx)("div",{className:"\n                        relative z-10 flex items-center justify-center w-10 h-10 rounded-full\n                        ".concat(d?"bg-blue-600 text-white":"bg-white border-2 border-gray-300 text-gray-600","\n                      "),children:(0,a.jsx)("span",{className:"text-sm font-semibold",children:0===e.version_number?"Init":"v".concat(e.version_number)})}),(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(D.Zb,{className:"\n                          cursor-pointer transition-all hover:shadow-md\n                          ".concat(d?"ring-2 ring-blue-600 ring-offset-2":"","\n                        "),onClick:()=>v(u?null:e.id),children:(0,a.jsxs)(D.aY,{className:"p-4",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("h4",{className:"font-semibold text-sm",children:0===e.version_number?"Initial Budget":"Version ".concat(e.version_number)}),(0,a.jsx)(i.C,{variant:o.variant,children:o.label}),d&&(0,a.jsx)(i.C,{variant:"default",className:"bg-blue-600",children:"Current"})]}),(0,a.jsx)(f.z,{variant:"ghost",size:"sm",onClick:t=>{t.stopPropagation(),n(e.version_number)},children:(0,a.jsx)(V.Z,{className:"w-4 h-4"})})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4 text-xs text-gray-600 mb-3",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)(en.Z,{className:"w-3 h-3"}),(0,es.WU)(new Date(e.created_at),"MMM d, yyyy")]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)(l.Z,{className:"w-3 h-3"}),(0,es.WU)(new Date(e.created_at),"h:mm a")]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)(ei.Z,{className:"w-3 h-3"}),e.created_by]})]}),(0,a.jsx)("div",{className:"mb-3",children:(0,a.jsxs)("p",{className:"text-sm text-gray-700",children:[(0,a.jsx)(U.Z,{className:"w-3 h-3 inline mr-1"}),e.reason_for_change]})}),e.version_number>0&&(0,a.jsxs)("div",{className:"flex items-center gap-4 pt-3 border-t",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[r.totalChange>=0?(0,a.jsx)(W.Z,{className:"w-4 h-4 text-green-600"}):(0,a.jsx)(K.Z,{className:"w-4 h-4 text-red-600"}),(0,a.jsx)("span",{className:"text-sm font-medium ".concat(r.totalChange>=0?"text-green-600":"text-red-600"),children:S(Math.abs(r.totalChange))})]}),(0,a.jsx)("div",{className:"text-xs text-gray-600",children:0!==r.changePercent&&(0,a.jsxs)("span",{children:["(",r.changePercent>0?"+":"",r.changePercent.toFixed(1),"%)"]})}),(0,a.jsxs)("div",{className:"text-xs text-gray-600",children:[r.itemsChanged," items changed"]})]}),u&&(null==c?void 0:c[e.version_number])&&(0,a.jsxs)("div",{className:"mt-4 pt-4 border-t",children:[(0,a.jsx)("h5",{className:"text-xs font-semibold text-gray-700 mb-2",children:"Top Changes"}),(0,a.jsx)("div",{className:"space-y-1",children:c[e.version_number].slice(0,3).map(e=>(0,a.jsxs)("div",{className:"flex justify-between text-xs",children:[(0,a.jsxs)("span",{className:"text-gray-600",children:[e.cost_line," - ",e.spend_sub_category]}),(0,a.jsx)("span",{className:"font-medium",children:S(e.forecasted_cost||e.budget_cost)})]},e.id))})]})]})})})]},e.id)})]})})})]}),(0,a.jsx)(j,{open:u,onOpenChange:e=>{m(e),e||(h(null),p(null),console.log("[VersionComparison] Dialog state reset:",{isOpen:e,compareFrom:null,compareTo:null,timestamp:Date.now()}))},children:(0,a.jsxs)(w,{className:"sm:max-w-[600px]",children:[(0,a.jsxs)(C,{children:[(0,a.jsx)(k,{children:"Compare Versions"}),(0,a.jsx)(E,{children:"Select two versions to see the differences between them"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 py-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium",children:"From Version"}),(0,a.jsxs)("select",{className:"w-full mt-1 px-3 py-2 border rounded-md",value:null!==x?x:"",onChange:e=>h(e.target.value?Number(e.target.value):null),"aria-label":"Select from version","aria-describedby":"version-from-helper",children:[(0,a.jsx)("option",{value:"",children:"Select version"}),y.map(e=>(0,a.jsxs)("option",{value:e.version_number,children:["Version ",e.version_number]},e.id))]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"text-sm font-medium",children:"To Version"}),(0,a.jsxs)("select",{className:"w-full mt-1 px-3 py-2 border rounded-md",value:null!==g?g:"",onChange:e=>p(e.target.value?Number(e.target.value):null),children:[(0,a.jsx)("option",{value:"",children:"Select version"}),y.filter(e=>null===x||e.version_number!==x).map(e=>(0,a.jsxs)("option",{value:e.version_number,children:["Version ",e.version_number]},e.id))]})]})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,a.jsx)(f.z,{variant:"outline",onClick:()=>m(!1),children:"Cancel"}),(0,a.jsxs)(f.z,{onClick:()=>{null!==x&&null!==g&&o&&(o(x,g),m(!1))},disabled:null===x||null===g,children:[(0,a.jsx)(ea.Z,{className:"w-4 h-4 mr-2"}),"Compare"]})]})]})})]})}function eo(e){let{...t}=e;return(0,a.jsx)(v.fC,{"data-slot":"sheet",...t})}function ec(e){let{...t}=e;return(0,a.jsx)(v.h_,{"data-slot":"sheet-portal",...t})}function ed(e){let{className:t,...s}=e;return(0,a.jsx)(v.aV,{"data-slot":"sheet-overlay",className:(0,m.cn)("data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",t),...s})}function eu(e){let{className:t,children:s,side:r="right",...n}=e;return(0,a.jsxs)(ec,{children:[(0,a.jsx)(ed,{}),(0,a.jsxs)(v.VY,{"data-slot":"sheet-content",className:(0,m.cn)("bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500","right"===r&&"data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm","left"===r&&"data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm","top"===r&&"data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b","bottom"===r&&"data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",t),...n,children:[s,(0,a.jsxs)(v.x8,{className:"ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none",children:[(0,a.jsx)(p.Z,{className:"size-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})}function em(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"sheet-header",className:(0,m.cn)("flex flex-col gap-1.5 p-4",t),...s})}function ex(e){let{className:t,...s}=e;return(0,a.jsx)(v.Dx,{"data-slot":"sheet-title",className:(0,m.cn)("text-foreground font-semibold",t),...s})}function eh(e){let{className:t,...s}=e;return(0,a.jsx)(v.dk,{"data-slot":"sheet-description",className:(0,m.cn)("text-muted-foreground text-sm",t),...s})}var eg=s(41136);let ep=(0,s(89940).j)("inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium hover:bg-muted hover:text-muted-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] outline-none transition-[color,box-shadow] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive whitespace-nowrap",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent shadow-xs hover:bg-accent hover:text-accent-foreground"},size:{default:"h-9 px-2 min-w-9",sm:"h-8 px-1.5 min-w-8",lg:"h-10 px-2.5 min-w-10"}},defaultVariants:{variant:"default",size:"default"}}),ef=r.createContext({size:"default",variant:"default"});function eb(e){let{className:t,variant:s,size:r,children:n,...i}=e;return(0,a.jsx)(eg.fC,{"data-slot":"toggle-group","data-variant":s,"data-size":r,className:(0,m.cn)("group/toggle-group flex w-fit items-center rounded-md data-[variant=outline]:shadow-xs",t),...i,children:(0,a.jsx)(ef.Provider,{value:{variant:s,size:r},children:n})})}function ev(e){let{className:t,children:s,variant:n,size:i,...l}=e,o=r.useContext(ef);return(0,a.jsx)(eg.ck,{"data-slot":"toggle-group-item","data-variant":o.variant||n,"data-size":o.size||i,className:(0,m.cn)(ep({variant:o.variant||n,size:o.size||i}),"min-w-0 flex-1 shrink-0 rounded-none shadow-none first:rounded-l-md last:rounded-r-md focus:z-10 focus-visible:z-10 data-[variant=outline]:border-l-0 data-[variant=outline]:first:border-l",t),...l,children:s})}var ej=s(56751);function ey(e){let{className:t,...s}=e;return(0,a.jsx)(ej.fC,{"data-slot":"tabs",className:(0,m.cn)("flex flex-col gap-2",t),...s})}function eN(e){let{className:t,...s}=e;return(0,a.jsx)(ej.aV,{"data-slot":"tabs-list",className:(0,m.cn)("bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",t),...s})}function e_(e){let{className:t,...s}=e;return(0,a.jsx)(ej.xz,{"data-slot":"tabs-trigger",className:(0,m.cn)("data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",t),...s})}function ew(e){let{className:t,...s}=e;return(0,a.jsx)(ej.VY,{"data-slot":"tabs-content",className:(0,m.cn)("flex-1 outline-none",t),...s})}var eC=s(5660),eS=s(30579),ek=s(10191),eE=s(26825),eD=s(36649),eP=s(85482),eF=s(44768),ez=s(72008),eI=s(35599),eZ=s(97010),eA=s(12488);function eL(e){let{data:t,title:s="Budget Change Waterfall",description:n}=e,i=(0,r.useMemo)(()=>{console.log("[Charts] WaterfallChart rendering:",{inputData:t,dataLength:t.length,timestamp:Date.now()});let e=new Map;t.forEach(t=>{let s=e.get(t.category)||0;e.set(t.category,s+t.change)});let s=[],a=t.reduce((e,t)=>e+(t.v1_amount||0),0);return s.push({name:"Start",value:a,displayValue:a,fill:"#6366f1",isTotal:!0}),Array.from(e.entries()).forEach(e=>{let[t,r]=e;if(0!==r){let e=a;a+=r,s.push({name:t,value:r>0?[e,a]:[a,e],displayValue:Math.abs(r),actualChange:r,fill:r>0?"#22c55e":"#ef4444",isTotal:!1})}}),s.push({name:"End",value:a,displayValue:a,fill:"#6366f1",isTotal:!0}),s},[t]),l=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.abs(e));return(0,a.jsxs)(D.Zb,{children:[(0,a.jsxs)(D.Ol,{children:[(0,a.jsx)(D.ll,{children:s}),n&&(0,a.jsx)(D.SZ,{children:n})]}),(0,a.jsx)(D.aY,{children:(0,a.jsx)(eS.h,{width:"100%",height:400,children:(0,a.jsxs)(ek.v,{data:i,margin:{top:20,right:30,left:20,bottom:60},children:[(0,a.jsx)(eE.q,{strokeDasharray:"3 3",stroke:"#e5e7eb"}),(0,a.jsx)(eD.K,{dataKey:"name",angle:-45,textAnchor:"end",height:100,tick:{fontSize:11}}),(0,a.jsx)(eP.B,{tickFormatter:e=>"$".concat((e/1e3).toFixed(0),"K"),tick:{fontSize:11}}),(0,a.jsx)(eF.u,{content:(0,a.jsx)(e=>{let{active:t,payload:s}=e;if(t&&s&&s[0]){let e=s[0].payload;return(0,a.jsxs)("div",{className:"bg-white p-3 border border-gray-200 rounded-lg shadow-lg",children:[(0,a.jsx)("p",{className:"font-medium text-sm",children:e.name}),(0,a.jsxs)("p",{className:"text-sm font-semibold ".concat(e.isTotal?"text-blue-600":e.actualChange>0?"text-green-600":"text-red-600"),children:[e.isTotal?"Total: ":e.actualChange>0?"+":"-",l(e.displayValue)]})]})}return null},{})}),(0,a.jsx)(ez.$,{dataKey:"value",shape:e=>{let{fill:t,x:s,y:r,width:n,height:i,payload:l}=e;return l.isTotal,(0,a.jsx)("rect",{x:s,y:r,width:n,height:i,fill:t,rx:4})},isAnimationActive:!1,children:i.map((e,t)=>(0,a.jsx)(eI.b,{fill:e.fill},"cell-".concat(t)))})]})})})]})}function eO(e){let{data:t}=e,s=(0,r.useMemo)(()=>(console.log("[Charts] CategoryComparison data:",{inputData:t,dataLength:t.length,timestamp:Date.now()}),t.map(e=>({...e,changePercent:e.changePercent||0,changeColor:e.change>0?"#22c55e":e.change<0?"#ef4444":"#94a3b8"}))),[t]);return(0,a.jsxs)(D.Zb,{children:[(0,a.jsxs)(D.Ol,{children:[(0,a.jsx)(D.ll,{children:"Category-Level Comparison"}),(0,a.jsx)(D.SZ,{children:"Budget changes by business line"})]}),(0,a.jsx)(D.aY,{children:(0,a.jsx)(eS.h,{width:"100%",height:350,children:(0,a.jsxs)(eZ.c,{data:s,margin:{top:20,right:30,left:20,bottom:60},children:[(0,a.jsx)(eE.q,{strokeDasharray:"3 3",stroke:"#e5e7eb"}),(0,a.jsx)(eD.K,{dataKey:"category",angle:-45,textAnchor:"end",height:100,tick:{fontSize:11}}),(0,a.jsx)(eP.B,{yAxisId:"amount",tickFormatter:e=>"$".concat((e/1e3).toFixed(0),"K"),tick:{fontSize:11}}),(0,a.jsx)(eP.B,{yAxisId:"percent",orientation:"right",tickFormatter:e=>"".concat(e,"%"),tick:{fontSize:11}}),(0,a.jsx)(eF.u,{formatter:(e,t)=>"Change %"===t?"".concat(e.toFixed(1),"%"):"$".concat((e/1e3).toFixed(1),"K")}),(0,a.jsx)(ez.$,{yAxisId:"amount",dataKey:"v1_total",fill:"#cbd5e1",name:"Version 1"}),(0,a.jsx)(ez.$,{yAxisId:"amount",dataKey:"v2_total",fill:"#6366f1",name:"Version 2"}),(0,a.jsx)(eA.x,{yAxisId:"percent",type:"monotone",dataKey:"changePercent",stroke:"#f97316",strokeWidth:2,name:"Change %",dot:{fill:"#f97316",r:4}})]})})})]})}function eT(e){let{data:t}=e,s=(0,r.useMemo)(()=>{let e=[...t].sort((e,t)=>Math.abs(t.change)-Math.abs(e.change));return{topIncreases:e.filter(e=>e.change>0).slice(0,3),topDecreases:e.filter(e=>e.change<0).slice(0,3),largestPercent:e.sort((e,t)=>Math.abs(t.changePercent)-Math.abs(e.changePercent))[0]}},[t]),n=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.abs(e));return(0,a.jsxs)("div",{className:"grid gap-4",children:[s.topIncreases.length>0&&(0,a.jsxs)(D.Zb,{className:"border-green-200 bg-green-50/30",children:[(0,a.jsx)(D.Ol,{className:"pb-3",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(W.Z,{className:"w-5 h-5 text-green-600"}),(0,a.jsx)(D.ll,{className:"text-base",children:"Top Budget Increases"})]})}),(0,a.jsx)(D.aY,{children:(0,a.jsx)("div",{className:"space-y-2",children:s.topIncreases.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:e.category}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:e.item})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("p",{className:"text-sm font-semibold text-green-600",children:["+",n(e.change)]}),(0,a.jsxs)("p",{className:"text-xs text-muted-foreground",children:["+",e.changePercent.toFixed(1),"%"]})]})]},t))})})]}),s.topDecreases.length>0&&(0,a.jsxs)(D.Zb,{className:"border-red-200 bg-red-50/30",children:[(0,a.jsx)(D.Ol,{className:"pb-3",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(K.Z,{className:"w-5 h-5 text-red-600"}),(0,a.jsx)(D.ll,{className:"text-base",children:"Top Budget Decreases"})]})}),(0,a.jsx)(D.aY,{children:(0,a.jsx)("div",{className:"space-y-2",children:s.topDecreases.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("p",{className:"text-sm font-medium",children:e.category}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground",children:e.item})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("p",{className:"text-sm font-semibold text-red-600",children:["-",n(Math.abs(e.change))]}),(0,a.jsxs)("p",{className:"text-xs text-muted-foreground",children:[e.changePercent.toFixed(1),"%"]})]})]},t))})})]}),s.largestPercent&&Math.abs(s.largestPercent.changePercent)>10&&(0,a.jsxs)(D.Zb,{className:"border-orange-200 bg-orange-50/30",children:[(0,a.jsx)(D.Ol,{className:"pb-3",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(u.Z,{className:"w-5 h-5 text-orange-600"}),(0,a.jsx)(D.ll,{className:"text-base",children:"Significant % Change"})]})}),(0,a.jsxs)(D.aY,{children:[(0,a.jsxs)("p",{className:"text-sm",children:[(0,a.jsx)("span",{className:"font-medium",children:s.largestPercent.category})," had a"," ",(0,a.jsxs)("span",{className:"font-bold ".concat(s.largestPercent.change>0?"text-green-600":"text-red-600"),children:[s.largestPercent.changePercent>0?"+":"",s.largestPercent.changePercent.toFixed(1),"%"]})," ","change (",s.largestPercent.change>0?"+":"",n(s.largestPercent.change),")"]}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:s.largestPercent.item})]})]})]})}var eM=s(70386),eV=s(52882);function eB(e){let{delayDuration:t=0,...s}=e;return(0,a.jsx)(eV.zt,{"data-slot":"tooltip-provider",delayDuration:t,...s})}function eU(e){let{...t}=e;return(0,a.jsx)(eB,{children:(0,a.jsx)(eV.fC,{"data-slot":"tooltip",...t})})}function eR(e){let{...t}=e;return(0,a.jsx)(eV.xz,{"data-slot":"tooltip-trigger",...t})}function eq(e){let{className:t,sideOffset:s=0,children:r,...n}=e;return(0,a.jsx)(eV.h_,{children:(0,a.jsxs)(eV.VY,{"data-slot":"tooltip-content",sideOffset:s,className:(0,m.cn)("bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",t),...n,children:[r,(0,a.jsx)(eV.Eh,{className:"bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]"})]})})}let eY={safePercentage:(e,t)=>null==e||null==t?0:0===t?0===e?0:e>0?100:-100:Number(((e-t)/Math.abs(t)*100).toFixed(2)),formatCurrency:e=>null==e?"$0":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),formatCompactCurrency:e=>{if(null==e)return"$0";let t=Math.abs(e),s=e<0?"-":"";return t>=1e6?"".concat(s,"$").concat((t/1e6).toFixed(1),"M"):t>=1e3?"".concat(s,"$").concat((t/1e3).toFixed(0),"K"):new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)},formatPercentage:e=>null==e||Number.isNaN(e)?"0%":"".concat(e>0?"+":"").concat(e.toFixed(1),"%"),getChangeStatus:(e,t)=>{let s=null!=e?e:0,a=null!=t?t:0;return 0===s&&a>0?"added":s>0&&0===a?"removed":s===a?"unchanged":a>s?"increased":"decreased"}};function eW(e){let{version:t,comparisonVersion:s,highlights:n=[],onScroll:l,scrollTop:o=0,height:c}=e,d=(0,r.useRef)(null),[u,x]=(0,r.useState)(!1);return(0,r.useEffect)(()=>{!u&&d.current&&void 0!==o&&(d.current.scrollTop=o)},[o,u]),(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsxs)("div",{className:"p-3 border-b bg-muted/30 sticky top-0 z-10",children:[(0,a.jsxs)("h3",{className:"font-semibold",children:["Version ",t.version]}),(0,a.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Total: ",eY.formatCompactCurrency(t.totalCost)]})]}),(0,a.jsx)("div",{ref:d,className:"flex-1 overflow-auto",onScroll:()=>{d.current&&(x(!0),null==l||l(d.current.scrollTop),setTimeout(()=>x(!1),150))},style:{height:c-80},children:t.costLines.map((e,t)=>{let r=null==s?void 0:s.costLines.find(t=>t.costLineName===e.costLineName),l=r?eY.safePercentage(e.totalCost,r.totalCost):null,o=r?eY.getChangeStatus(r.totalCost,e.totalCost):"unchanged",c=n.includes(e.costLineName);return(0,a.jsxs)("div",{className:(0,m.cn)("px-4 py-3 border-b flex items-center justify-between transition-colors hover:bg-muted/50",c&&"bg-yellow-50","increased"===o&&"bg-red-50","decreased"===o&&"bg-green-50"),children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"font-medium",children:e.costLineName}),(0,a.jsx)(eB,{children:(0,a.jsxs)(eU,{children:[(0,a.jsx)(eR,{asChild:!0,children:(0,a.jsx)("div",{className:"text-lg cursor-help",children:eY.formatCompactCurrency(e.totalCost)})}),(0,a.jsx)(eq,{children:(0,a.jsx)("p",{children:eY.formatCurrency(e.totalCost)})})]})})]}),null!==l&&0!==l&&(0,a.jsx)(i.C,{variant:"increased"===o?"destructive":"decreased"===o?"outline":"secondary",className:(0,m.cn)("ml-2",l>0&&"text-red-600 dark:text-red-400",l<0&&"text-green-600 dark:text-green-400",0===l&&"text-gray-600 dark:text-gray-400"),children:eY.formatPercentage(l)}),!r&&e.totalCost>0&&(0,a.jsx)(i.C,{variant:"secondary",className:"ml-2 text-green-600 dark:text-green-400",children:"New +100%"})]},t)})})]})}var eK=s(57373),eQ=s(1112),e$=s(46878),eX=s(29498),eG=s(79173);function eH(e){return null==e?"$0":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function eJ(e){return"".concat(e>0?"+":"").concat(e.toFixed(1),"%")}function e0(e){let{title:t,value:s,change:r,trend:n="neutral",icon:i,className:l,description:o}=e,c={up:(0,a.jsx)(W.Z,{className:"h-4 w-4"}),down:(0,a.jsx)(K.Z,{className:"h-4 w-4"}),neutral:(0,a.jsx)(eK.Z,{className:"h-4 w-4"})};return(0,a.jsx)(D.Zb,{className:(0,m.cn)("hover:shadow-md transition-shadow",l),children:(0,a.jsxs)(D.aY,{className:"p-4",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between space-x-2",children:[(0,a.jsxs)("div",{className:"space-y-1 flex-1",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-muted-foreground",children:t}),(0,a.jsx)("p",{className:"text-2xl font-bold tracking-tight",children:s}),o&&(0,a.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:o})]}),i&&(0,a.jsx)("div",{className:"text-muted-foreground",children:i})]}),void 0!==r&&(0,a.jsxs)("div",{className:(0,m.cn)("flex items-center gap-1 mt-2",{up:"text-red-600 dark:text-red-400",down:"text-green-600 dark:text-green-400",neutral:"text-muted-foreground"}[n]),children:[c[n],(0,a.jsx)("span",{className:"text-xs font-medium",children:r})]})]})})}function e1(e){let{isOpen:t,onClose:s,projectData:n,versions:l,mode:o="sheet",showAdvancedFeatures:c=!1}=e,d=function(){let[e,t]=r.useState(void 0);return r.useEffect(()=>{let e=window.matchMedia("(max-width: ".concat(767,"px)")),s=()=>{t(window.innerWidth<768)};return e.addEventListener("change",s),t(window.innerWidth<768),()=>e.removeEventListener("change",s)},[]),!!e}(),[u,x]=(0,r.useState)("all"),[h,g]=(0,r.useState)(""),[p,b]=(0,r.useState)("all"),[v,y]=(0,r.useState)("overview"),[N,_]=(0,r.useState)("side-by-side"),[S,D]=(0,r.useState)(1),[P,F]=(0,r.useState)(2);(0,r.useEffect)(()=>{l.length>=2&&(D(l[0].version),F(l[1].version))},[l]);let z=l.find(e=>e.version===S)||l[0],I=l.find(e=>e.version===P)||l[1],A=(0,r.useMemo)(()=>{if(!z||!I)return null;let e=new Map(z.costLines.map(e=>[e.costLineName,e])),t=new Map(I.costLines.map(e=>[e.costLineName,e])),s=new Set([...e.keys(),...t.keys()]),a=[];s.forEach(s=>{let r=e.get(s),n=t.get(s),i=(null==r?void 0:r.totalCost)||0,l=(null==n?void 0:n.totalCost)||0,o=l-i,c=0!==i?o/Math.abs(i)*100:0!==l?100:0,d="unchanged";!r&&n?d="added":r&&!n?d="removed":o>0?d="increased":o<0&&(d="decreased"),a.push({id:(null==n?void 0:n.id)||(null==r?void 0:r.id)||s,costLineName:s,category:(null==n?void 0:n.category)||(null==r?void 0:r.category)||"Uncategorized",v1_amount:i,v2_amount:l,change:o,changePercent:c,status:d})});let r=I.totalCost-z.totalCost,n=0!==z.totalCost?r/Math.abs(z.totalCost)*100:0,i=a.filter(e=>"added"===e.status).length,l=a.filter(e=>"removed"===e.status).length,o=a.filter(e=>"increased"===e.status).length,c=a.filter(e=>"decreased"===e.status).length;return{differences:a,summary:{v1Total:z.totalCost,v2Total:I.totalCost,totalChange:r,changePercent:n,addedCount:i,removedCount:l,increasedCount:o,decreasedCount:c,totalLines:a.length}}},[z,I]),T=(0,r.useMemo)(()=>{if(!A)return[];let e=[...A.differences];if("all"!==u&&(e="changed"===u?e.filter(e=>"unchanged"!==e.status):e.filter(e=>e.status===u)),"all"!==p&&(e=e.filter(e=>e.category===p)),h){let t=h.toLowerCase();e=e.filter(e=>e.costLineName.toLowerCase().includes(t)||e.category.toLowerCase().includes(t))}return e.sort((e,t)=>Math.abs(t.change)-Math.abs(e.change))},[A,u,p,h]),V=(0,r.useMemo)(()=>A?Array.from(new Set(A.differences.map(e=>e.category))).sort():[],[A]),B=(0,r.useCallback)(()=>{if(!A)return;let e=new Blob([[["Cost Line","Category","Version ".concat(z.version),"Version ".concat(I.version),"Change","Change %","Status"],...T.map(e=>[e.costLineName,e.category,e.v1_amount,e.v2_amount,e.change,"".concat(e.changePercent.toFixed(2),"%"),e.status])].map(e=>e.join(",")).join("\n")],{type:"text/csv"}),t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download="version-comparison-".concat(n.name,"-v").concat(z.version,"-v").concat(I.version,".csv"),s.click(),URL.revokeObjectURL(t)},[A,T,n,z,I]);if(!A)return null;let U=(0,a.jsxs)("div",{className:"flex flex-col h-full",children:[(0,a.jsxs)("div",{className:"space-y-4 mb-6",children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(M.Ph,{value:S.toString(),onValueChange:e=>D(Number(e)),children:[(0,a.jsx)(M.i4,{className:"w-[150px]",children:(0,a.jsx)(M.ki,{placeholder:"Select version"})}),(0,a.jsx)(M.Bw,{children:l.map(e=>(0,a.jsxs)(M.Ql,{value:e.version.toString(),children:["Version ",e.version]},e.version))})]}),(0,a.jsx)(G.Z,{className:"h-5 w-5 self-center text-muted-foreground"}),(0,a.jsxs)(M.Ph,{value:P.toString(),onValueChange:e=>F(Number(e)),children:[(0,a.jsx)(M.i4,{className:"w-[150px]",children:(0,a.jsx)(M.ki,{placeholder:"Select version"})}),(0,a.jsx)(M.Bw,{children:l.map(e=>(0,a.jsxs)(M.Ql,{value:e.version.toString(),children:["Version ",e.version]},e.version))})]}),(0,a.jsxs)("div",{className:"ml-auto flex gap-2",children:[!d&&(0,a.jsxs)(eb,{type:"single",value:N,onValueChange:e=>e&&_(e),children:[(0,a.jsx)(ev,{value:"side-by-side","aria-label":"Side by side view",children:(0,a.jsx)(eQ.Z,{className:"h-4 w-4"})}),(0,a.jsx)(ev,{value:"unified","aria-label":"Unified view",children:(0,a.jsx)(e$.Z,{className:"h-4 w-4"})})]}),(0,a.jsxs)(f.z,{variant:"outline",size:"sm",onClick:B,children:[(0,a.jsx)(er.Z,{className:"h-4 w-4 mr-1"}),"Export"]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[(0,a.jsx)(e0,{title:"Total Change",value:eH(A.summary.totalChange),change:eJ(A.summary.changePercent),trend:A.summary.totalChange>0?"up":A.summary.totalChange<0?"down":"neutral",icon:(0,a.jsx)(eX.Z,{className:"h-5 w-5"})}),(0,a.jsx)(e0,{title:"Items Changed",value:A.summary.totalLines-A.differences.filter(e=>"unchanged"===e.status).length,description:"of ".concat(A.summary.totalLines," total"),icon:(0,a.jsx)(eG.Z,{className:"h-5 w-5"})}),(0,a.jsx)(e0,{title:"Items Added",value:A.summary.addedCount,trend:"neutral",icon:(0,a.jsx)(q.Z,{className:"h-5 w-5"})}),(0,a.jsx)(e0,{title:"Items Removed",value:A.summary.removedCount,trend:"neutral",icon:(0,a.jsx)(eK.Z,{className:"h-5 w-5"})})]})]}),(0,a.jsxs)(ey,{value:v,onValueChange:y,className:"flex-1 flex flex-col",children:[(0,a.jsxs)(eN,{className:"grid grid-cols-3 w-full max-w-[400px]",children:[(0,a.jsx)(e_,{value:"overview",children:"Overview"}),(0,a.jsx)(e_,{value:"details",children:"Details"}),(0,a.jsx)(e_,{value:"charts",children:"Charts"})]}),(0,a.jsx)(ew,{value:"overview",className:"flex-1 mt-4",children:(0,a.jsxs)("div",{className:"space-y-6",children:[c&&(0,a.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,a.jsxs)(M.Ph,{value:u,onValueChange:e=>x(e),children:[(0,a.jsx)(M.i4,{className:"w-[150px]",children:(0,a.jsx)(M.ki,{})}),(0,a.jsxs)(M.Bw,{children:[(0,a.jsx)(M.Ql,{value:"all",children:"All Items"}),(0,a.jsx)(M.Ql,{value:"changed",children:"Changed Only"}),(0,a.jsx)(M.Ql,{value:"added",children:"Added"}),(0,a.jsx)(M.Ql,{value:"removed",children:"Removed"}),(0,a.jsx)(M.Ql,{value:"increased",children:"Increased"}),(0,a.jsx)(M.Ql,{value:"decreased",children:"Decreased"})]})]}),(0,a.jsxs)(M.Ph,{value:p,onValueChange:b,children:[(0,a.jsx)(M.i4,{className:"w-[150px]",children:(0,a.jsx)(M.ki,{})}),(0,a.jsxs)(M.Bw,{children:[(0,a.jsx)(M.Ql,{value:"all",children:"All Categories"}),V.map(e=>(0,a.jsx)(M.Ql,{value:e,children:e},e))]})]}),(0,a.jsx)(O,{placeholder:"Search cost lines...",value:h,onChange:e=>g(e.target.value),className:"w-[200px]"})]}),"side-by-side"!==N||d?(0,a.jsx)(Z,{className:"h-[600px]",children:(0,a.jsxs)(L.iA,{children:[(0,a.jsx)(L.xD,{children:(0,a.jsxs)(L.SC,{children:[(0,a.jsx)(L.ss,{children:"Cost Line"}),(0,a.jsx)(L.ss,{children:"Category"}),(0,a.jsxs)(L.ss,{className:"text-right",children:["V",z.version]}),(0,a.jsxs)(L.ss,{className:"text-right",children:["V",I.version]}),(0,a.jsx)(L.ss,{className:"text-right",children:"Change"}),(0,a.jsx)(L.ss,{className:"text-center",children:"Status"})]})}),(0,a.jsx)(L.RM,{children:T.map(e=>(0,a.jsxs)(L.SC,{children:[(0,a.jsx)(L.pj,{className:"font-medium",children:e.costLineName}),(0,a.jsx)(L.pj,{children:(0,a.jsx)(i.C,{variant:"outline",children:e.category})}),(0,a.jsx)(L.pj,{className:"text-right",children:eH(e.v1_amount)}),(0,a.jsx)(L.pj,{className:"text-right",children:eH(e.v2_amount)}),(0,a.jsx)(L.pj,{className:"text-right",children:(0,a.jsxs)("span",{className:(0,m.cn)("font-medium",e.change>0&&"text-red-600",e.change<0&&"text-green-600"),children:[eH(e.change),(0,a.jsxs)("span",{className:"text-xs ml-1",children:["(",eJ(e.changePercent),")"]})]})}),(0,a.jsx)(L.pj,{className:"text-center",children:(0,a.jsx)(i.C,{variant:"added"===e.status?"default":"removed"===e.status?"secondary":"increased"===e.status?"destructive":(e.status,"outline"),children:e.status})})]},e.id))})]})}):(0,a.jsxs)(eM.pO,{direction:"horizontal",className:"min-h-[600px]",children:[(0,a.jsx)(eM.ee,{defaultSize:50,children:(0,a.jsx)(eW,{version:z,comparisonVersion:I,height:600})}),(0,a.jsx)(eM.Dp,{withHandle:!0}),(0,a.jsx)(eM.ee,{defaultSize:50,children:(0,a.jsx)(eW,{version:I,comparisonVersion:z,height:600})})]})]})}),(0,a.jsx)(ew,{value:"details",className:"flex-1 mt-4",children:(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsx)(eT,{data:T.map(e=>({category:e.category,item:e.costLineName,change:e.change,changePercent:e.changePercent}))})})}),(0,a.jsx)(ew,{value:"charts",className:"flex-1 mt-4",children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(eL,{data:A.differences.map(e=>({...e,category:e.category||"Uncategorized"})),title:"Budget Change Waterfall",description:"Visual breakdown of changes between versions"}),(0,a.jsx)(eO,{data:(()=>{let e=new Map;return A.differences.forEach(t=>{let s=t.category||"Uncategorized",a=e.get(s)||{v1:0,v2:0};a.v1+=t.v1_amount||0,a.v2+=t.v2_amount||0,e.set(s,a)}),Array.from(e.entries()).map(e=>{let[t,s]=e;return{category:t,v1_total:s.v1,v2_total:s.v2,change:s.v2-s.v1,changePercent:0!==s.v1?(s.v2-s.v1)/Math.abs(s.v1)*100:0}})})()})]})})]})]});return"dialog"===o?(0,a.jsx)(j,{open:t,onOpenChange:s,children:(0,a.jsxs)(w,{className:"max-w-[90vw] max-h-[90vh] overflow-y-auto",children:[(0,a.jsxs)(C,{children:[(0,a.jsxs)(k,{children:["Version Comparison - ",n.name]}),(0,a.jsx)(E,{children:"Compare budget versions to understand changes and trends"})]}),U]})}):(0,a.jsx)(eo,{open:t,onOpenChange:s,children:(0,a.jsxs)(eu,{side:"right",className:"w-full sm:w-[90%] sm:max-w-[1400px] overflow-y-auto","aria-describedby":"version-comparison-description",children:[(0,a.jsxs)(em,{children:[(0,a.jsxs)(ex,{children:["Version Comparison - ",n.name]}),(0,a.jsx)(eh,{id:"version-comparison-description",children:"Compare budget versions to understand changes and trends"})]}),(0,a.jsx)(eC.Z,{className:"my-4"}),U]})})}var e2=s(40814);let e4="cost-management-backup",e3="1.0.0";class e5{static saveBackup(e){try{let t={stagedEntries:e,timestamp:Date.now(),version:e3};localStorage.setItem(e4,JSON.stringify(t))}catch(e){console.error("Failed to save backup:",e)}}static loadBackup(){try{let e=localStorage.getItem(e4);if(!e)return null;let t=JSON.parse(e);if((Date.now()-t.timestamp)/36e5>24)return this.clearBackup(),null;if(t.version!==e3)return console.warn("Backup version mismatch, discarding"),this.clearBackup(),null;return t}catch(e){return console.error("Failed to load backup:",e),null}}static clearBackup(){try{localStorage.removeItem(e4)}catch(e){console.error("Failed to clear backup:",e)}}static hasBackup(){return null!==localStorage.getItem(e4)}}function e6(e){let{value:t,onSave:s,type:n="text",className:i,placeholder:l="Click to edit",disabled:o=!1,formatter:c,validator:d}=e,[u,x]=(0,r.useState)(!1),[h,g]=(0,r.useState)(t),[p,f]=(0,r.useState)(null),b=(0,r.useRef)(null);(0,r.useEffect)(()=>{g(t)},[t]),(0,r.useEffect)(()=>{u&&b.current&&(b.current.focus(),b.current.select())},[u]);let v=()=>{if(d){let e=d(h);if(!0!==e){f("string"==typeof e?e:"Invalid value");return}}h!==t&&s("number"===n?Number(h):h),x(!1),f(null)},j=()=>{g(t),x(!1),f(null)},y=c?c(t):t;return o?(0,a.jsx)("span",{className:(0,m.cn)("inline-block",i),children:y||(0,a.jsx)("span",{className:"text-gray-400",children:l})}):u?(0,a.jsxs)("div",{className:"relative inline-block",children:[(0,a.jsx)(O,{ref:b,type:n,value:h,onChange:e=>{g(e.target.value),f(null)},onBlur:v,onKeyDown:e=>{"Enter"===e.key?v():"Escape"===e.key&&j()},className:(0,m.cn)("h-auto py-1 px-2",p&&"border-red-500 focus:ring-red-500",i)}),p&&(0,a.jsx)("div",{className:"absolute top-full left-0 mt-1 text-xs text-red-600 whitespace-nowrap z-10",children:p})]}):(0,a.jsx)("button",{onClick:()=>x(!0),className:(0,m.cn)("inline-block cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 rounded px-2 py-1 -mx-2 -my-1 transition-colors","focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",i),children:y||(0,a.jsx)("span",{className:"text-gray-400",children:l})})}var e7=s(79101);let e8=[{category:"General",items:[{keys:["âŒ˜/Ctrl","S"],description:"Save changes"},{keys:["âŒ˜/Ctrl","N"],description:"New entry"},{keys:["Esc"],description:"Cancel/Close"}]},{category:"Selection",items:[{keys:["âŒ˜/Ctrl","A"],description:"Select all items"},{keys:["Delete"],description:"Delete selected items"},{keys:["Space"],description:"Toggle item selection"}]},{category:"Navigation",items:[{keys:["Tab"],description:"Next field"},{keys:["Shift","Tab"],description:"Previous field"},{keys:["Enter"],description:"Save and next"}]},{category:"Editing",items:[{keys:["Click"],description:"Start inline edit"},{keys:["Enter"],description:"Save edit"},{keys:["Esc"],description:"Cancel edit"}]}];function e9(){return(0,a.jsxs)(j,{children:[(0,a.jsx)(y,{asChild:!0,children:(0,a.jsxs)("button",{className:"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-8 px-3",children:[(0,a.jsx)(e7.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"hidden lg:inline",children:"Shortcuts"})]})}),(0,a.jsxs)(w,{className:"sm:max-w-[600px]",children:[(0,a.jsxs)(C,{children:[(0,a.jsx)(k,{children:"Keyboard Shortcuts"}),(0,a.jsx)(E,{children:"Use these keyboard shortcuts to work faster"})]}),(0,a.jsx)("div",{className:"space-y-6",children:e8.map(e=>(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-semibold text-sm text-gray-900 dark:text-gray-100 mb-2",children:e.category}),(0,a.jsx)("div",{className:"space-y-2",children:e.items.map(e=>(0,a.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:e.description}),(0,a.jsx)("div",{className:"flex items-center gap-1",children:e.keys.map((t,s)=>(0,a.jsxs)("span",{children:[(0,a.jsx)("kbd",{className:"px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600",children:t}),s<e.keys.length-1&&(0,a.jsx)("span",{className:"mx-1 text-gray-400",children:"+"})]},s))})]},e.description))})]},e.category))})]})]})}var te=s(96024);function tt(e){let{budget:t,actual:s,loading:r=!1,className:n,onViewDetails:l}=e,o=t-s.total,c=t>0?o/t*100:0,d=t>0?s.total/t*100:0,x=s.total>0?s.invoiced/s.total*100:0,h=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.abs(e)),g=e=>{let t=Math.abs(e);return t>=1e6?"$".concat((t/1e6).toFixed(1),"M"):t>=1e3?"$".concat((t/1e3).toFixed(0),"K"):new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t)};return r?(0,a.jsxs)(D.Zb,{className:n,children:[(0,a.jsx)(D.Ol,{children:(0,a.jsxs)(D.ll,{className:"text-lg flex items-center gap-2",children:[(0,a.jsx)(eX.Z,{className:"w-5 h-5"}),"Budget vs Actual"]})}),(0,a.jsx)(D.aY,{children:(0,a.jsx)("div",{className:"flex items-center justify-center py-8",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})})]}):0===s.mappingCount?(0,a.jsxs)(D.Zb,{className:(0,m.cn)("border-dashed",n),children:[(0,a.jsx)(D.Ol,{children:(0,a.jsxs)(D.ll,{className:"text-lg flex items-center gap-2",children:[(0,a.jsx)(eX.Z,{className:"w-5 h-5"}),"Budget vs Actual"]})}),(0,a.jsx)(D.aY,{children:(0,a.jsxs)("div",{className:"text-center py-6",children:[(0,a.jsx)(te.Z,{className:"w-12 h-12 mx-auto text-gray-400 mb-3"}),(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"No PO mappings found"}),(0,a.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"Map POs to see actual spending"})]})})]}):(0,a.jsxs)(D.Zb,{className:n,children:[(0,a.jsx)(D.Ol,{children:(0,a.jsxs)(D.ll,{className:"text-lg flex items-center gap-2",children:[(0,a.jsx)(eX.Z,{className:"w-5 h-5"}),"Budget vs Actual"]})}),(0,a.jsxs)(D.aY,{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Budget"}),(0,a.jsx)(eB,{children:(0,a.jsxs)(eU,{children:[(0,a.jsx)(eR,{asChild:!0,children:(0,a.jsx)("p",{className:"text-xl font-bold cursor-help",children:g(t)})}),(0,a.jsx)(eq,{children:(0,a.jsx)("p",{children:h(t)})})]})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm text-muted-foreground",children:"Actual (POs)"}),(0,a.jsx)(eB,{children:(0,a.jsxs)(eU,{children:[(0,a.jsx)(eR,{asChild:!0,children:(0,a.jsx)("p",{className:"text-xl font-bold cursor-help",children:g(s.total)})}),(0,a.jsx)(eq,{children:(0,a.jsx)("p",{children:h(s.total)})})]})})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,a.jsx)("span",{className:"text-muted-foreground",children:"Budget Utilization"}),(0,a.jsxs)("span",{className:"font-medium",children:[d.toFixed(1),"%"]})]}),(0,a.jsx)(F.E,{value:Math.min(d,100),className:(0,m.cn)("h-2",d>100&&"[&>div]:bg-red-500",d>90&&d<=100&&"[&>div]:bg-yellow-500")}),d>100&&(0,a.jsxs)("div",{className:"flex items-center gap-1 text-xs text-red-600",children:[(0,a.jsx)(u.Z,{className:"w-3 h-3"}),"Over budget by ",h(Math.abs(o))]})]}),(0,a.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsxs)("span",{className:"text-muted-foreground flex items-center gap-1",children:[(0,a.jsx)(U.Z,{className:"w-3 h-3"}),"Invoiced"]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"font-medium",children:h(s.invoiced)}),(0,a.jsxs)(i.C,{variant:"outline",className:"text-xs",children:[x.toFixed(0),"%"]})]})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsxs)("span",{className:"text-muted-foreground flex items-center gap-1",children:[(0,a.jsx)(te.Z,{className:"w-3 h-3"}),"Open"]}),(0,a.jsx)("span",{className:"font-medium",children:h(s.open)})]})]}),(0,a.jsx)(eC.Z,{}),(0,a.jsxs)("div",{className:(0,m.cn)("flex justify-between items-center",o>=0?"text-green-600":10>=Math.abs(c)?"text-yellow-600":"text-red-600"),children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[o>=0?(0,a.jsx)(K.Z,{className:"w-4 h-4"}):(0,a.jsx)(W.Z,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"font-medium",children:"Variance"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("span",{className:"font-bold",children:[o>=0?"-":"+",h(o)]}),(0,a.jsxs)(i.C,{variant:o>=0?"default":"destructive",className:"text-xs",children:[c>0?"-":"+",Math.abs(c).toFixed(1),"%"]})]})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"text-xs text-muted-foreground text-center",children:["Based on ",s.mappingCount," mapped PO",1!==s.mappingCount?"s":""]}),l&&(0,a.jsx)(f.z,{variant:"outline",size:"sm",className:"w-full",onClick:l,children:"View PO Details"})]})]})]})}var ts=s(19122);let ta=["WIS","Drilling","Production","Facilities","Subsea","FPSO"],tr=["M&S","Services","Equipment","Labor","Contractors","Consumables"],tn=["Operational","Maintenance","Capital","Emergency","Planned"];function ti(){var e;let{toast:t}=(0,e2.pm)(),s=(0,ts.useRouter)(),[i,l]=(0,r.useState)(""),[o,c]=(0,r.useState)([]),[d,u]=(0,r.useState)(new Set),[m,x]=(0,r.useState)({}),[g,p]=(0,r.useState)(null),[v,j]=(0,r.useState)(null),[y,N]=(0,r.useState)(!0),[_,w]=(0,r.useState)(new Set),[C,S]=(0,r.useState)(null),[k,E]=(0,r.useState)(null),[D,P]=(0,r.useState)(!1),[F,z]=(0,r.useState)(null),[I,Z]=(0,r.useState)(null),[A,L]=(0,r.useState)({}),[O,T]=(0,r.useState)(""),[M,V]=(0,r.useState)({}),[B,U]=(0,r.useState)({}),[R,q]=(0,r.useState)(!1),[Y,W]=(0,r.useState)({}),[K,Q]=(0,r.useState)({}),$=(0,r.useRef)(new Set),[X,G]=(0,r.useState)(null),H=(0,n.e)(),[J,ee]=(0,r.useState)({}),[es,ea]=(0,r.useState)({}),[er,en]=(0,r.useState)(!1),[ei,eo]=(0,r.useState)({name:"",sub_business_line:""}),[ec,ed]=(0,r.useState)(!1),[eu,em]=(0,r.useState)(new Set),[ex,eh]=(0,r.useState)({}),[eg,ep]=(0,r.useState)(null),[ef,eb]=(0,r.useState)({}),[ev,ej]=(0,r.useState)(null),[ey,eN]=(0,r.useState)(new Set),[e_,ew]=(0,r.useState)(!1),[eC,eS]=(0,r.useState)(null),[ek,eE]=(0,r.useState)(null),[eD,eP]=(0,r.useState)({}),[eF,ez]=(0,r.useState)(!1),eI=e=>{var t;let s=null===(t=e.id)||void 0===t?void 0:t.startsWith("temp_"),a=e._modified,r="hover:bg-gray-50";return s?r+=" bg-amber-50/50 border-l-4 border-l-amber-500":a&&(r+=" bg-blue-50/50 border-l-4 border-l-blue-500"),r},eZ=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;for(let a=0;a<t;a++)try{return await e()}catch(e){if(a===t-1)throw e;console.log("Retry attempt ".concat(a+1," of ").concat(t," after ").concat(s,"ms")),await new Promise(e=>setTimeout(e,s))}throw Error("Max retries exceeded")},eA=e=>{let t=[];if("id"in e&&"string"==typeof e.id&&e.id.startsWith("temp_")&&t.push("id (temporary)"),"_tempId"in e&&t.push("_tempId"),Object.keys(e).forEach(e=>{e.startsWith("_")&&t.push(e)}),t.length>0)throw console.error("Invalid fields detected in database entry:",t),console.error("Entry:",e),Error("Cannot save entry with temporary fields: ".concat(t.join(", ")));let s=["project_id","sub_business_line","cost_line","spend_type","spend_sub_category"].filter(t=>!e[t]||""===e[t]);if(s.length>0)throw Error("Missing required fields: ".concat(s.join(", ")))},eL=(e,t)=>{let{id:s,_tempId:a,...r}=e,n={project_id:r.project_id||t,sub_business_line:r.sub_business_line||"",cost_line:r.cost_line||"",spend_type:r.spend_type||"",spend_sub_category:r.spend_sub_category||"",budget_cost:"number"==typeof r.budget_cost?r.budget_cost:parseFloat(r.budget_cost)||0};return eA(n),n},eO=e=>{var t,s;return((null===(t=ex[e])||void 0===t?void 0:t.length)||0)+((null===(s=m[e])||void 0===s?void 0:s.filter(e=>e._modified).length)||0)};(0,r.useEffect)(()=>{let e={};o.forEach(t=>{e[t.id]=eO(t.id)}),eb(e)},[ex,m,o]),(0,r.useEffect)(()=>{let e=e=>{let t=document.activeElement,s=(null==t?void 0:t.tagName)==="INPUT"||(null==t?void 0:t.tagName)==="TEXTAREA"||(null==t?void 0:t.tagName)==="SELECT";if((e.metaKey||e.ctrlKey)&&"s"===e.key){e.preventDefault();let t=Array.from(d)[0];t&&ef[t]>0&&tg(t)}if(!s&&(e.metaKey||e.ctrlKey)&&"n"===e.key){e.preventDefault();let t=Array.from(d)[0];t&&(I===t||eg===t)&&S(t)}if("Escape"===e.key&&(g?ti():C?(S(null),E(null)):ey.size>0&&eN(new Set)),!s&&(e.metaKey||e.ctrlKey)&&"a"===e.key){let t=Array.from(d)[0];t&&(I===t||eg===t)&&(e.preventDefault(),tb(t,!0))}if(!s&&("Delete"===e.key||"Backspace"===e.key)&&ey.size>0){e.preventDefault();let t=Array.from(d)[0];t&&tf(t)}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[d,ef,g,C,ey,I,eg]),(0,r.useEffect)(()=>{let e=setTimeout(()=>{Object.keys(ex).some(e=>ex[e].length>0)&&(e5.saveBackup(ex),console.log("Auto-saved to localStorage"))},5e3);return()=>clearTimeout(e)},[ex]),(0,r.useEffect)(()=>{let e=e5.loadBackup();e&&e.stagedEntries&&Object.keys(e.stagedEntries).some(t=>e.stagedEntries[t].length>0)&&t({title:"Recovery Available",description:"Unsaved changes were recovered from your last session",action:(0,a.jsx)(f.z,{size:"sm",onClick:()=>{eh(e.stagedEntries),Object.entries(e.stagedEntries).forEach(e=>{let[t,s]=e;x(e=>({...e,[t]:[...e[t]||[],...s]}))})},children:"Restore"})})},[]),(0,r.useEffect)(()=>{eT()},[]),(0,r.useEffect)(()=>{if(o.length>0&&0===d.size){let e=o[0].id;u(new Set([e])),V(t=>({...t,[e]:"latest"})),(async()=>{let t=B[e];t||(t=await eR(e)),m[e]||(t&&t.length>0?(console.log("First project has ".concat(t.length," versions, loading latest")),await eV(e,"latest")):(console.log("First project has no versions, loading base cost breakdown"),await eM(e)))})()}},[o]);let eT=async()=>{try{let{data:e,error:t}=await H.from("projects").select("*").order("created_at",{ascending:!1});if(t)throw t;c(e||[])}catch(e){console.error("Error loading projects:",e),t({variant:"destructive",title:"Failed to Load Projects",description:"Unable to load projects. Please refresh the page."})}finally{N(!1)}},eM=async e=>{try{let t=B[e];if(t&&t.length>0)console.log("Found forecast versions, loading latest instead of base cost breakdown"),await eV(e,"latest");else{let{data:t,error:s}=await H.from("cost_breakdown").select("*").eq("project_id",e).order("spend_sub_category");if(s)throw s;x(s=>({...s,[e]:t||[]}))}}catch(e){console.error("Error loading cost breakdown:",e),t({variant:"destructive",title:"Failed to Load Cost Breakdown",description:"Unable to load cost details. Please try again."})}},eV=async(e,t)=>{let s="".concat(e,"-").concat(t);if($.current.has(s)){console.log("Already loading ".concat(s,", skipping duplicate request"));return}$.current.add(s),Q(t=>({...t,[e]:!0}));try{if("latest"===t){let t=B[e]||[];if(t.length>0){let s=Math.max(...t.map(e=>e.version_number)),{data:a,error:r}=await H.from("forecast_versions").select("*").eq("project_id",e).eq("version_number",s).single();if(r)throw r;let{data:n,error:i}=await H.from("budget_forecasts").select("\n              *,\n              cost_breakdown (*)\n            ").eq("forecast_version_id",a.id).order("id");if(i)throw console.error("Error loading forecast data:",i),i;if(n&&0!==n.length){let t=n.map(e=>{var t,s,a;return console.log("Forecast item:",{breakdown_id:null===(t=e.cost_breakdown)||void 0===t?void 0:t.id,original_budget:null===(s=e.cost_breakdown)||void 0===s?void 0:s.budget_cost,forecasted_cost:e.forecasted_cost}),{...e.cost_breakdown,budget_cost:e.forecasted_cost,forecast_id:e.id,_original_budget:null===(a=e.cost_breakdown)||void 0===a?void 0:a.budget_cost}});console.log("Loaded latest version (".concat(s,") for project ").concat(e,":"),t.length,"items"),console.log("Transformed data sample:",t[0]),x(s=>({...s,[e]:t}))}else{console.warn("No forecast data found for version ".concat(s," of project ").concat(e));let{data:t,error:a}=await H.from("cost_breakdown").select("*").eq("project_id",e).order("spend_sub_category");if(a)throw a;x(s=>({...s,[e]:t||[]}))}}else{let{data:t,error:s}=await H.from("cost_breakdown").select("*").eq("project_id",e).order("spend_sub_category");if(s)throw s;x(s=>({...s,[e]:t||[]}))}}else if(0===t){console.log("Loading Version 0 (original) data for project ".concat(e));let{data:t,error:s}=await H.from("forecast_versions").select("*").eq("project_id",e).eq("version_number",0).single();if(t&&!s){console.log("Found version 0 in forecast_versions, loading from budget_forecasts");let{data:s,error:a}=await H.from("budget_forecasts").select("\n                *,\n                cost_breakdown (*)\n              ").eq("forecast_version_id",t.id).order("id");if(a)throw a;let r=(null==s?void 0:s.map(e=>{var t;return{...e.cost_breakdown,budget_cost:e.forecasted_cost||e.cost_breakdown.budget_cost,forecast_id:e.id,_original_budget:null===(t=e.cost_breakdown)||void 0===t?void 0:t.budget_cost}}))||[];console.log("Loaded Version 0 from forecasts for project ".concat(e,":"),r.length,"items"),x(t=>({...t,[e]:r}))}else{console.log("No version 0 found, loading from cost_breakdown table");let{data:t,error:s}=await H.from("cost_breakdown").select("*").eq("project_id",e).order("created_at",{ascending:!0});if(s)throw s;console.log("Loaded from cost_breakdown for project ".concat(e,":"),null==t?void 0:t.length,"items"),x(s=>({...s,[e]:t||[]}))}}else{let{data:s,error:a}=await H.from("forecast_versions").select("*").eq("project_id",e).eq("version_number",t).single();if(a)throw a;let{data:r,error:n}=await H.from("budget_forecasts").select("\n              *,\n              cost_breakdown (*)\n            ").eq("forecast_version_id",s.id).order("id");if(n)throw console.error("Error loading forecast data:",n),n;if(r&&0!==r.length){let s=r.map(e=>{var t,s,a;return console.log("Forecast item:",{breakdown_id:null===(t=e.cost_breakdown)||void 0===t?void 0:t.id,original_budget:null===(s=e.cost_breakdown)||void 0===s?void 0:s.budget_cost,forecasted_cost:e.forecasted_cost}),{...e.cost_breakdown,budget_cost:e.forecasted_cost,forecast_id:e.id,_original_budget:null===(a=e.cost_breakdown)||void 0===a?void 0:a.budget_cost}});console.log("Loaded version ".concat(t," for project ").concat(e,":"),s.length,"items"),console.log("Transformed data sample:",s[0]),x(t=>({...t,[e]:s}))}else{console.warn("No forecast data found for version ".concat(t," of project ").concat(e));let{data:s,error:a}=await H.from("cost_breakdown").select("*").eq("project_id",e).order("spend_sub_category");if(a)throw a;x(t=>({...t,[e]:s||[]}))}}}catch(e){console.error("Error loading version cost breakdown:",e)}finally{Q(t=>({...t,[e]:!1}));let s="".concat(e,"-").concat(t);$.current.delete(s)}},eB=async(e,s,a)=>{ez(!0),console.log("[loadComparisonData] Starting comparison load:",{projectId:e,v1:s,v2:a});try{let t={},r=async t=>{let{data:s,error:a}=await H.from("forecast_versions").select("*").eq("project_id",e).eq("version_number",t).single();if(s&&s.id){let{data:e,error:a}=await H.from("budget_forecasts").select("*").eq("forecast_version_id",s.id).order("id");if(a)throw a;return console.log("[loadComparisonData] Version ".concat(t," forecasts from budget_forecasts:"),{count:(null==e?void 0:e.length)||0,versionId:s.id}),e||[]}if(0!==t)return console.warn("[loadComparisonData] Version ".concat(t," not found")),[];{let{data:t,error:s}=await H.from("cost_breakdown").select("*").eq("project_id",e).gt("budget_cost",0).order("spend_sub_category");if(s)throw s;return console.log("[loadComparisonData] Version 0 baseline items (budget_cost > 0):",{count:(null==t?void 0:t.length)||0,items:null==t?void 0:t.map(e=>({name:e.spend_sub_category,budget_cost:e.budget_cost}))}),(null==t?void 0:t.map(e=>({id:"v0_".concat(e.id),forecast_version_id:"version_0",cost_breakdown_id:e.id,forecasted_cost:e.budget_cost})))||[]}},[n,i]=await Promise.all([r(s),r(a)]);t[s]=n,t[a]=i;let{data:l,error:o}=await H.from("cost_breakdown").select("*").eq("project_id",e).order("cost_line, spend_sub_category");return o?console.error("Error loading cost breakdown:",o):t.originalItems=l||[],console.log("[loadComparisonData] Loaded data:",{v1Count:n.length,v2Count:i.length,originalItemsCount:(null==l?void 0:l.length)||0,v1Sample:n.slice(0,2),v2Sample:i.slice(0,2),originalSample:null==l?void 0:l.slice(0,2)}),eP(t),t}catch(e){return console.error("Error loading comparison data:",e),t({variant:"destructive",title:"Failed to Load Comparison Data",description:"Unable to load version data for comparison. Please try again."}),{}}finally{ez(!1)}},eU=async e=>{ea(t=>({...t,[e]:!0}));try{let{data:t,error:s}=await H.from("po_mappings").select("\n          id,\n          project_id,\n          po_number,\n          line_item_number,\n          cost_breakdown_id,\n          amount\n        ").eq("project_id",e);if(s)throw s;if(t&&t.length>0){let s=t.map(e=>({po_number:e.po_number,line_item:e.line_item_number})),{data:a,error:r}=await H.from("po_line_items").select("\n            po_number,\n            line_item,\n            net_value_usd,\n            invoiced_value_usd,\n            open_value_usd,\n            material_description\n          ").or(s.map(e=>"and(po_number.eq.".concat(e.po_number,",line_item.eq.").concat(e.line_item,")")).join(","));if(r)throw r;let n=new Map;null==a||a.forEach(e=>{n.set("".concat(e.po_number,"-").concat(e.line_item),e)});let i={total:0,invoiced:0,open:0,mappingCount:t.length,mappings:t.map(e=>{let t=n.get("".concat(e.po_number,"-").concat(e.line_item_number));return{...e,lineItemDetails:t||null}})};t.forEach(e=>{let t=n.get("".concat(e.po_number,"-").concat(e.line_item_number));if(t){let s=e.amount?e.amount/t.net_value_usd:1;i.total+=t.net_value_usd*s,i.invoiced+=t.invoiced_value_usd*s,i.open+=t.open_value_usd*s}}),ee(t=>({...t,[e]:i}))}else ee(t=>({...t,[e]:{total:0,invoiced:0,open:0,mappingCount:0,mappings:[]}}))}catch(e){console.error("Error fetching PO mappings:",e),t({variant:"destructive",title:"Failed to Load PO Data",description:"Unable to fetch PO mappings for budget comparison"})}finally{ea(t=>({...t,[e]:!1}))}},eR=async e=>{try{let{data:t,error:s}=await H.from("forecast_versions").select("*").eq("project_id",e).order("version_number",{ascending:!1});if(s)throw s;U(s=>({...s,[e]:t||[]}));let a=null==t?void 0:t.some(e=>0===e.version_number);return W(t=>({...t,[e]:a||!1})),t||[]}catch(e){return console.error("Error loading forecast versions:",e),[]}},[eq,eY]=(0,r.useState)({}),eW=e=>{let t=[];return e.forEach((e,s)=>{e.cost_line&&""!==e.cost_line.trim()||t.push("Entry ".concat(s+1,": Cost line is required")),e.spend_type&&""!==e.spend_type.trim()||t.push("Entry ".concat(s+1,": Spend type is required")),e.spend_sub_category&&""!==e.spend_sub_category.trim()||t.push("Entry ".concat(s+1,": Spend sub-category is required")),e.sub_business_line&&""!==e.sub_business_line.trim()||t.push("Entry ".concat(s+1,": Sub-business line is required"));let a=parseFloat(e.budget_cost);if((isNaN(a)||a<0)&&t.push("Entry ".concat(s+1,": Budget cost must be a valid positive number")),e.budget_cost&&e.budget_cost.toString().includes(".")){let a=e.budget_cost.toString().split(".")[1];a&&a.length>2&&t.push("Entry ".concat(s+1,": Budget cost can have maximum 2 decimal places"))}}),{valid:0===t.length,errors:t}},eK=async e=>{q(!0);try{let s,a;let r=ex[e]||[];if(console.log("=== SAVING INITIAL VERSION DEBUG ==="),console.log("Project ID:",e),console.log("Number of staged entries:",r.length),console.log("Staged entries structure:",JSON.stringify(r,null,2)),0===r.length){t({variant:"destructive",title:"No entries to save",description:"Please add at least one entry before saving"}),q(!1);return}let n=eW(r);if(!n.valid){console.error("Validation errors:",n.errors),t({variant:"destructive",title:"Validation Errors",description:n.errors.join(", ")}),q(!1);return}let i=r.map(t=>eL(t,e));console.log("Cleaned entries for RPC:",JSON.stringify(i,null,2)),console.log("Attempting to save initial version..."),console.log("Using direct database insertion method (RPC bypass)..."),console.log("Using direct insertion method with improved error handling...");let l=[],o=null;try{o=await eZ(async()=>{let{data:t,error:s}=await H.from("forecast_versions").insert({project_id:e,version_number:0,reason_for_change:"Initial budget creation",created_by:"system"}).select().single();if(s)throw s;return t},3,1e3);for(let e=0;e<i.length;e+=5)for(let t of i.slice(e,e+5)){let e=await eZ(async()=>{let{data:e,error:s}=await H.from("cost_breakdown").insert({...t,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(s)throw s;return e},2,500);l.push(e),await eZ(async()=>{let{error:s}=await H.from("budget_forecasts").insert({forecast_version_id:o.id,cost_breakdown_id:e.id,forecasted_cost:t.budget_cost,created_at:new Date().toISOString()});if(s)throw s},2,500)}s=[{success:!0,version_id:o.id,message:"Initial forecast created successfully",entries_saved:l.length}],a=null}catch(e){if(console.error("Database insertion failed:",e),o){console.log("Attempting to cleanup partial data...");try{if(await H.from("forecast_versions").delete().eq("id",o.id),l.length>0){let e=l.map(e=>e.id);await H.from("cost_breakdown").delete().in("id",e)}}catch(e){console.error("Cleanup failed:",e)}}a=e,s=null}if(console.log("RPC Response - Data:",s),console.log("RPC Response - Error:",a),a)throw console.error("RPC Error Details:",{message:a.message,details:a.details,hint:a.hint,code:a.code}),a;if(!s||!Array.isArray(s)||0===s.length)throw console.error("Unexpected RPC response format:",s),Error("Invalid response format from RPC function");let c=s[0];if(console.log("RPC Result:",c),!c.success)throw console.error("RPC Function Failed:",c.message),Error(c.message||"RPC function returned failure");W(t=>({...t,[e]:!0})),ep(null),eh(t=>({...t,[e]:[]})),await eM(e),await eR(e),e5.clearBackup(),t({title:"Success",description:"Initial budget saved successfully"})}catch(a){var s;console.error("Error saving initial version:",a);let e="Error saving initial version. ";(null==a?void 0:a.code)==="PGRST202"?e+="The database function is not available. Please contact support.":(null==a?void 0:a.code)==="23505"?e+="An initial version already exists for this project.":(null==a?void 0:a.code)==="22P02"?e+="Invalid data format. Please check all fields are filled correctly.":(null==a?void 0:null===(s=a.message)||void 0===s?void 0:s.includes("violates foreign key"))?e+="Project reference is invalid. Please refresh and try again.":(null==a?void 0:a.message)?e+="Details: ".concat(a.message):e+="Please check your entries and try again.",t({variant:"destructive",title:"Error Saving",description:e})}finally{q(!1)}},eQ=async(e,t)=>{console.log("Version change requested: ".concat(t," for project ").concat(e));let s="latest"===t?"latest":Number.parseInt(t),a=M[e];if(a===s||(null==a?void 0:a.toString())===(null==s?void 0:s.toString())){console.log("Already on version ".concat(s,", skipping reload"));return}console.log("Switching from version ".concat(M[e]," to ").concat(s)),V(t=>({...t,[e]:s})),await eV(e,s)},e$=async e=>{w(t=>new Set(t).add(e.id));try{if(e.id&&e.id.startsWith("temp_"))eh(t=>{var s;return{...t,[e.project_id]:(null===(s=t[e.project_id])||void 0===s?void 0:s.map(t=>t.id===e.id?{...e,_modified:!0}:t))||[]}}),x(t=>{var s;return{...t,[e.project_id]:(null===(s=t[e.project_id])||void 0===s?void 0:s.map(t=>t.id===e.id?{...e,_modified:!0}:t))||[]}}),console.log("Staged entry updated:",e.id),t({title:"Changes Staged",description:"Your changes will be saved with the initial budget"});else{let{error:t}=await H.from("cost_breakdown").update({sub_business_line:e.sub_business_line,cost_line:e.cost_line,spend_type:e.spend_type,spend_sub_category:e.spend_sub_category,budget_cost:e.budget_cost}).eq("id",e.id);if(t)throw t;x(t=>{var s;return{...t,[e.project_id]:(null===(s=t[e.project_id])||void 0===s?void 0:s.map(t=>t.id===e.id?e:t))||[]}})}p(null),j(null)}catch(e){console.error("Error updating cost item:",e),t({variant:"destructive",title:"Update Failed",description:"Failed to update cost item. Please try again."})}finally{w(t=>{let s=new Set(t);return s.delete(e.id),s})}},eX=async(e,s,a,r)=>{if(!(null==s?void 0:s.trim())){t({variant:"destructive",title:"Validation Error",description:"Please provide a reason for this forecast."});return}q(!0);try{let n=B[e]||[],i=n.length>0?Math.max(...n.map(e=>e.version_number))+1:1,l=[];if(r.length>0){for(let t of(console.log("Processing ".concat(r.length," new entries for forecast version ").concat(i)),r)){let s=eL(t,e);console.log("Saving new forecast entry to database:",s);let a=await eZ(async()=>{let{data:e,error:t}=await H.from("cost_breakdown").insert([s]).select().single();if(t)throw t;return e},2,500);l.push(a)}console.log("Added ".concat(l.length," new entries to cost_breakdown"))}let{data:o,error:c}=await H.from("forecast_versions").insert({project_id:e,version_number:i,reason_for_change:s,created_by:"current_user"}).select().single();if(c)throw c;let d=(m[e]||[]).filter(e=>e.id&&!e.id.startsWith("temp_"));console.log("Creating forecast with changes:",a),console.log("Current costs:",d.length),console.log("New entries saved:",l.length);let u=[...d.map(e=>({forecast_version_id:o.id,cost_breakdown_id:e.id,forecasted_cost:void 0!==a[e.id]?a[e.id]:e.budget_cost})),...l.map(e=>({forecast_version_id:o.id,cost_breakdown_id:e.id,forecasted_cost:e.budget_cost}))];if(console.log("Saving forecast entries:",u.length),u.length>0){let{error:e}=await H.from("budget_forecasts").insert(u);if(e)throw e}await eR(e),console.log("Setting active version to ".concat(i," after save from wizard")),V(t=>({...t,[e]:i})),await new Promise(e=>setTimeout(e,100)),await eV(e,i),Z(null),L({}),T(""),em(new Set),eh(t=>({...t,[e]:[]})),e5.clearBackup(),t({title:"Forecast Saved",description:"Version ".concat(i," has been created successfully")})}catch(e){console.error("Error saving forecast:",e),t({variant:"destructive",title:"Error Saving Forecast",description:(null==e?void 0:e.message)||"Failed to save forecast. Please try again."})}finally{q(!1)}},eG=async(e,s)=>{if(!(null==s?void 0:s.trim())){t({variant:"destructive",title:"Validation Error",description:"Please provide a reason for this forecast."});return}q(!0);try{let a=B[e]||[],r=a.length>0?Math.max(...a.map(e=>e.version_number))+1:1,n=ex[e]||[],i=[];if(n.length>0)for(let t of(console.log("Saving ".concat(n.length," new entries to cost_breakdown")),n)){let s=eL(t,e);console.log("Saving entry to database:",s);let a=await eZ(async()=>{let{data:e,error:t}=await H.from("cost_breakdown").insert([s]).select().single();if(t)throw t;return e},2,500);i.push(a)}let{data:l,error:o}=await H.from("forecast_versions").insert({project_id:e,version_number:r,reason_for_change:s,created_by:"current_user"}).select().single();if(o)throw o;let c=(m[e]||[]).filter(e=>e.id&&!e.id.startsWith("temp_")).map(e=>({forecast_version_id:l.id,cost_breakdown_id:e.id,forecasted_cost:void 0!==A[e.id]?A[e.id]:e.budget_cost})),d=i.map(e=>({forecast_version_id:l.id,cost_breakdown_id:e.id,forecasted_cost:e.budget_cost})),u=[...c,...d];if(u.length>0){let{error:e}=await H.from("budget_forecasts").insert(u);if(e)throw e}await eR(e),console.log("Setting active version to ".concat(r," after regular forecast save")),V(t=>({...t,[e]:r})),await new Promise(e=>setTimeout(e,100)),await eV(e,r),Z(null),L({}),T(""),em(new Set),eh(t=>({...t,[e]:[]})),e5.clearBackup(),t({title:"Forecast Saved",description:"Version ".concat(r," has been created successfully")})}catch(n){var a,r;console.error("Error saving forecast:",n);let s="Error saving forecast. ";(null==n?void 0:null===(a=n.message)||void 0===a?void 0:a.includes("temporary fields"))?s+="Internal error: temporary fields detected. Please refresh and try again.":(null==n?void 0:n.code)==="PGRST204"?s+="Database schema error. Please contact support.":(null==n?void 0:n.code)==="23505"?s+="Duplicate entry detected. Please check your entries.":(null==n?void 0:n.code)==="22P02"?s+="Invalid data format. Please check all fields.":(null==n?void 0:n.message)?s+="Details: ".concat(n.message):s+="Please check your entries and try again.",t({variant:"destructive",title:"Error Saving",description:s}),console.error("Detailed error context:",{projectId:e,stagedEntriesCount:(null===(r=ex[e])||void 0===r?void 0:r.length)||0,forecastReason:O,error:n})}finally{q(!1)}},eH=e=>{ej(e),Z(e),L({}),T("")},eJ=e=>{let t=new Set((ex[e]||[]).map(e=>e.id));x(s=>({...s,[e]:(s[e]||[]).filter(e=>!t.has(e.id))})),Z(null),L({}),T(""),em(new Set),eh(t=>({...t,[e]:[]}))},e0=e=>{l(e)},e4=o.filter(e=>e.name.toLowerCase().includes(i.toLowerCase())||e.sub_business_line.toLowerCase().includes(i.toLowerCase())),e3=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),e7=e=>e.reduce((e,t)=>e+Number(t.budget_cost),0),e8=async e=>{if(d.has(e.id))u(t=>{let s=new Set(t);return s.delete(e.id),s});else{u(t=>new Set(t).add(e.id)),M[e.id]||V(t=>({...t,[e.id]:"latest"}));let t=B[e.id];t||(t=await eR(e.id)),m[e.id]||(t&&t.length>0?(console.log("Project ".concat(e.id," has ").concat(t.length," versions, loading latest")),await eV(e.id,"latest")):(console.log("Project ".concat(e.id," has no versions, loading base cost breakdown")),await eM(e.id))),J[e.id]||await eU(e.id)}},te=e=>{p(e.id),j({...e})},ti=()=>{p(null),j(null)},tl=()=>{v&&e$(v)},to=async e=>{P(!0);try{if(eg===e.project_id||I===e.project_id){let t="temp_".concat(crypto.randomUUID?crypto.randomUUID():"".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))),s={...e,id:t,_tempId:t};eh(t=>({...t,[e.project_id]:[...t[e.project_id]||[],s]})),x(t=>({...t,[e.project_id]:[...t[e.project_id]||[],s]}))}else{let{error:t}=await H.from("cost_breakdown").insert([e]).select().single();if(t)throw t;await eM(e.project_id)}}catch(e){console.error("Error adding new cost entry:",e)}finally{P(!1)}},tc=async e=>{z(e);try{let t=Object.keys(m).find(t=>m[t].some(t=>t.id===e));if(!t)throw Error("Could not find project for cost entry");if(e&&e.startsWith("temp_"))eh(s=>{var a;return{...s,[t]:(null===(a=s[t])||void 0===a?void 0:a.filter(t=>t.id!==e))||[]}}),x(s=>{var a;return{...s,[t]:(null===(a=s[t])||void 0===a?void 0:a.filter(t=>t.id!==e))||[]}}),console.log("Staged entry deleted:",e);else{let{error:s}=await H.from("cost_breakdown").delete().eq("id",e);if(s)throw s;await eM(t)}}catch(e){console.error("Error deleting cost entry:",e),t({variant:"destructive",title:"Delete Failed",description:"Failed to delete cost entry. Please try again."})}finally{z(null)}},td=async e=>{G(e);try{let{error:t}=await H.from("projects").delete().eq("id",e);if(t)throw t;await eT()}catch(e){console.error("Error deleting project:",e)}finally{G(null)}},tu=async()=>{ed(!0);try{let{data:e,error:t}=await H.from("projects").insert([ei]).select().single();if(t)throw t;await eT(),en(!1),eo({name:"",sub_business_line:""})}catch(e){console.error("Error creating new project:",e),t({variant:"destructive",title:"Error Creating Project",description:"Error creating new project. Please try again."})}finally{ed(!1)}},tm=(e,t)=>{L(s=>({...s,[e]:t}))},tx=e=>{ep(e),eh(t=>({...t,[e]:[]}))},th=e=>{let t=new Set((ex[e]||[]).map(e=>e.id));x(s=>({...s,[e]:(s[e]||[]).filter(e=>!t.has(e.id))})),ep(null),eh(t=>({...t,[e]:[]}))},tg=async e=>{eg===e?await eK(e):I===e&&await eG(e,O)},tp=e=>{confirm("Are you sure you want to discard all unsaved changes?")&&(eh(t=>({...t,[e]:[]})),x(t=>{var s;return{...t,[e]:(null===(s=t[e])||void 0===s?void 0:s.map(e=>({...e,_modified:!1})))||[]}}),t({title:"Changes Discarded",description:"All unsaved changes have been discarded"}))},tf=async e=>{if(0===ey.size||!confirm("Are you sure you want to delete ".concat(ey.size," selected entries?")))return;let s=Array.from(ey),a=0;for(let t of s)try{if(t.startsWith("temp_"))eh(s=>{var a;return{...s,[e]:(null===(a=s[e])||void 0===a?void 0:a.filter(e=>e.id!==t))||[]}}),x(s=>{var a;return{...s,[e]:(null===(a=s[e])||void 0===a?void 0:a.filter(e=>e.id!==t))||[]}});else{let{error:e}=await H.from("cost_breakdown").delete().eq("id",t);!e&&a++}}catch(e){console.error("Failed to delete entry ".concat(t,":"),e)}a>0&&await eM(e),eN(new Set),t({title:"Bulk Delete Complete",description:"Successfully deleted ".concat(a," entries")})},tb=(e,t)=>{let s=m[e]||[];t?eN(new Set(s.map(e=>e.id))):eN(new Set)},tv=e=>{eN(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})};return(0,a.jsxs)("div",{className:"container mx-auto p-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold",children:"Cost Management Hub"}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)(e9,{}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{type:"text",placeholder:"Search projects...",value:i,onChange:e=>e0(e.target.value),className:"pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),(0,a.jsx)("svg",{className:"absolute left-3 top-2.5 h-5 w-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]}),!er&&(0,a.jsx)("button",{onClick:()=>en(!0),className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:"Create New Project"})]})]}),er&&(0,a.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-blue-900 mb-4",children:"Create New Project"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Project Name"}),(0,a.jsx)("input",{type:"text",value:ei.name,onChange:e=>eo({...ei,name:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter project name"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Sub Business Line"}),(0,a.jsxs)("select",{value:ei.sub_business_line,onChange:e=>eo({...ei,sub_business_line:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[(0,a.jsx)("option",{value:"",children:"Select sub business line"}),ta.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{onClick:tu,disabled:ec||!ei.name.trim()||!ei.sub_business_line.trim(),className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:ec?"Creating...":"Create Project"}),(0,a.jsx)("button",{onClick:()=>{en(!1),eo({name:"",sub_business_line:""})},className:"bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors",children:"Cancel"})]})]}),y?(0,a.jsxs)("div",{className:"text-center py-8",children:[(0,a.jsx)("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"}),(0,a.jsx)("p",{className:"mt-2 text-gray-600",children:"Loading projects..."})]}):0===e4.length?(0,a.jsx)("div",{className:"text-center py-8",children:(0,a.jsx)("p",{className:"text-gray-600",children:"No projects found."})}):(0,a.jsx)("div",{className:"space-y-4",children:e4.map(e=>{var t,r,n,i,l,o;return(0,a.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg",children:(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsx)("button",{onClick:()=>e8(e),className:"text-blue-600 hover:text-blue-800 transition-colors",children:(0,a.jsx)("svg",{className:"h-5 w-5 transform transition-transform ".concat(d.has(e.id)?"rotate-90":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-xl font-semibold",children:e.name}),(0,a.jsx)("p",{className:"text-gray-600",children:e.sub_business_line})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[m[e.id]&&(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsx)("p",{className:"text-sm text-gray-600",children:"Total Budget"}),(0,a.jsx)("p",{className:"text-lg font-semibold text-green-600",children:e3(e7(m[e.id]))})]}),(0,a.jsxs)("button",{onClick:()=>s.push("/projects/".concat(e.id,"/dashboard")),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[(0,a.jsx)("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"})}),"Dashboard"]}),(0,a.jsx)("button",{onClick:()=>{confirm("Are you sure you want to delete this project? This will permanently delete all project data including budgets, versions, and cost breakdowns.")&&td(e.id)},disabled:X===e.id,className:"text-red-600 hover:text-red-800 disabled:opacity-50 transition-colors",children:X===e.id?(0,a.jsx)("div",{className:"inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-red-600"}):(0,a.jsx)("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]}),d.has(e.id)&&(0,a.jsxs)("div",{className:"mt-6 border-t pt-6",children:[J[e.id]&&(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsx)(tt,{budget:e7(m[e.id]||[]),actual:J[e.id],loading:es[e.id],className:"mb-4",onViewDetails:()=>{s.push("/po-mapping?project=".concat(e.id))}})}),B[e.id]&&B[e.id].length>0&&(0,a.jsx)("div",{className:"mb-6",children:(0,a.jsx)(el,{versions:B[e.id],currentVersion:M[e.id]||"latest",onVersionSelect:t=>eQ(e.id,t.toString()),onCompareVersions:async(t,s)=>{eE({v1:t,v2:s}),eS(e.id),await eB(e.id,t,s)},isLoading:K[e.id]})}),(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsx)("h4",{className:"text-lg font-semibold",children:"Cost Breakdown"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[B[e.id]&&B[e.id].length>0&&(0,a.jsxs)("select",{value:(null===(t=M[e.id])||void 0===t?void 0:t.toString())||"latest",onChange:t=>{console.log("Dropdown changed to:",t.target.value),eQ(e.id,t.target.value)},className:"px-3 py-1 border border-gray-300 rounded-md text-sm",disabled:K[e.id],children:[(0,a.jsx)("option",{value:"latest",children:"Latest"}),(0,a.jsx)("option",{value:"0",children:"Version 0 (Original)"}),B[e.id].filter(e=>0!==e.version_number).map(e=>(0,a.jsxs)("option",{value:e.version_number.toString(),children:["Version ",e.version_number]},e.id))]}),eg===e.id?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("span",{className:"text-sm text-blue-600 font-medium",children:["Initial Budget Mode (",(null===(r=ex[e.id])||void 0===r?void 0:r.length)||0," entries)"]}),(0,a.jsx)("button",{onClick:()=>eK(e.id),disabled:R||0===((null===(n=ex[e.id])||void 0===n?void 0:n.length)||0),className:"bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700 disabled:opacity-50 transition-colors",children:R?"Saving...":"Save Initial Budget"}),(0,a.jsx)("button",{onClick:()=>th(e.id),className:"bg-gray-500 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-600 transition-colors",children:"Cancel"})]}):I===e.id?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("span",{className:"text-sm text-blue-600 font-medium",children:["Forecasting Mode (",Object.keys(A).length+((null===(i=ex[e.id])||void 0===i?void 0:i.length)||0)," ","changes)"]}),(0,a.jsx)("input",{type:"text",placeholder:"Reason for forecast...",value:O,onChange:e=>T(e.target.value),className:"px-3 py-1 border border-gray-300 rounded-md text-sm"}),(0,a.jsx)("button",{onClick:()=>eG(e.id,O),disabled:R||!O.trim(),className:"bg-green-600 text-white px-3 py-1 rounded-md text-sm hover:bg-green-700 disabled:opacity-50 transition-colors",children:R?"Saving...":"Save Forecast"}),(0,a.jsx)("button",{onClick:()=>eJ(e.id),className:"bg-gray-500 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-600 transition-colors",children:"Cancel"})]}):(0,a.jsx)("div",{className:"flex items-center gap-2",children:Y[e.id]||m[e.id]&&0!==m[e.id].length?!Y[e.id]&&(null===(l=m[e.id])||void 0===l?void 0:l.length)>0?(0,a.jsx)("button",{onClick:()=>eK(e.id),className:"bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700 transition-colors",children:"Save Initial Version"}):(0,a.jsx)("button",{onClick:()=>eH(e.id),className:"bg-orange-600 text-white px-3 py-1 rounded-md text-sm hover:bg-orange-700 transition-colors",children:"Create New Forecast"}):(0,a.jsx)("button",{onClick:()=>tx(e.id),className:"bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700 transition-colors",children:"Create Initial Budget"})})]})]}),K[e.id]?(0,a.jsxs)("div",{className:"text-center py-4",children:[(0,a.jsx)("div",{className:"inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"}),(0,a.jsx)("p",{className:"mt-2 text-sm text-gray-600",children:"Loading version data..."})]}):(0,a.jsxs)(a.Fragment,{children:[m[e.id]&&0!==m[e.id].length||eg?m[e.id]&&m[e.id].length>0?(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full border-collapse border border-gray-300",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"bg-gray-50",children:[(I===e.id||eg===e.id)&&(0,a.jsx)("th",{className:"border border-gray-300 px-2 py-2 text-center",children:(0,a.jsx)("input",{type:"checkbox",onChange:t=>tb(e.id,t.target.checked),checked:(null===(o=m[e.id])||void 0===o?void 0:o.length)>0&&m[e.id].every(e=>ey.has(e.id)),className:"w-4 h-4"})}),(0,a.jsx)("th",{className:"border border-gray-300 px-4 py-2 text-left",children:"Status"}),(0,a.jsx)("th",{className:"border border-gray-300 px-4 py-2 text-left",children:"Cost Line"}),(0,a.jsx)("th",{className:"border border-gray-300 px-4 py-2 text-left",children:"Spend Type"}),(0,a.jsx)("th",{className:"border border-gray-300 px-4 py-2 text-left",children:"Sub Category"}),(0,a.jsx)("th",{className:"border border-gray-300 px-4 py-2 text-left",children:"Budget Cost"}),(0,a.jsx)("th",{className:"border border-gray-300 px-4 py-2 text-center",children:"Actions"})]})}),(0,a.jsx)("tbody",{children:m[e.id].map(t=>{var s;return(0,a.jsxs)("tr",{className:eI(t),children:[(I===e.id||eg===e.id)&&(0,a.jsx)("td",{className:"border border-gray-300 px-2 py-2 text-center",children:(0,a.jsx)("input",{type:"checkbox",checked:ey.has(t.id),onChange:()=>tv(t.id),className:"w-4 h-4"})}),g===t.id&&(I===e.id||eg===e.id)?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2",children:(0,a.jsx)(h,{id:t.id,modified:t._modified,saving:_.has(t.id)})}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2",children:(0,a.jsxs)("select",{value:(null==v?void 0:v.cost_line)||"",onChange:e=>j(v?{...v,cost_line:e.target.value}:null),className:"w-full px-2 py-1 border border-gray-300 rounded",children:[(0,a.jsx)("option",{value:"",children:"Select cost line"}),tr.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2",children:(0,a.jsxs)("select",{value:(null==v?void 0:v.spend_type)||"",onChange:e=>j(v?{...v,spend_type:e.target.value}:null),className:"w-full px-2 py-1 border border-gray-300 rounded",children:[(0,a.jsx)("option",{value:"",children:"Select spend type"}),tn.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2",children:(0,a.jsx)("input",{type:"text",value:(null==v?void 0:v.spend_sub_category)||"",onChange:e=>j(v?{...v,spend_sub_category:e.target.value}:null),className:"w-full px-2 py-1 border border-gray-300 rounded"})}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2",children:(0,a.jsx)("input",{type:"number",value:(null==v?void 0:v.budget_cost)||"",onChange:e=>j(v?{...v,budget_cost:Number(e.target.value)}:null),className:"w-full px-2 py-1 border border-gray-300 rounded text-right"})}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2 text-center",children:(0,a.jsxs)("div",{className:"flex gap-1 justify-center",children:[(0,a.jsx)("button",{onClick:tl,disabled:_.has(t.id),className:"bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 disabled:opacity-50 transition-colors",children:_.has(t.id)?"...":"Save"}),(0,a.jsx)("button",{onClick:ti,className:"bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600 transition-colors",children:"Cancel"})]})})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2",children:(0,a.jsx)(h,{id:t.id,modified:t._modified,saving:_.has(t.id)})}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2",children:t.cost_line}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2",children:t.spend_type}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2",children:t.spend_sub_category}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2 text-right",children:I===e.id?(0,a.jsx)(e6,{value:null!==(s=A[t.id])&&void 0!==s?s:t.budget_cost,onSave:e=>tm(t.id,Number(e)),type:"number",formatter:e=>e3(e),validator:e=>{let t=Number(e);return!isNaN(t)&&!(t<0)||"Value must be a positive number"},className:"text-right"}):e3(t.budget_cost)}),(0,a.jsx)("td",{className:"border border-gray-300 px-4 py-2 text-center",children:(I===e.id||eg===e.id)&&(0,a.jsxs)("div",{className:"flex gap-1 justify-center",children:[(0,a.jsx)("button",{onClick:()=>te(t),className:"bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition-colors",children:"Edit"}),(0,a.jsx)("button",{onClick:()=>{confirm("Are you sure you want to delete this cost entry?")&&tc(t.id)},disabled:F===t.id,className:"bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 disabled:opacity-50 transition-colors",children:F===t.id?"...":"Delete"})]})})]})]},t.id)})})]})}):null:(0,a.jsxs)("div",{className:"text-center py-8 bg-gray-50 rounded-lg",children:[(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:"No budget has been created for this project yet."}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:'Click "Create Initial Budget" to get started.'})]}),(I===e.id||eg===e.id)&&(0,a.jsx)("div",{className:"mt-4",children:C===e.id?(0,a.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg",children:[(0,a.jsx)("h5",{className:"font-semibold mb-3",children:"Add New Cost Entry"}),(0,a.jsxs)("div",{className:"grid grid-cols-4 gap-3 mb-3",children:[(0,a.jsxs)("select",{value:(null==k?void 0:k.cost_line)||"",onChange:t=>E(k?{...k,cost_line:t.target.value}:{project_id:e.id,sub_business_line:e.sub_business_line,cost_line:t.target.value,spend_type:"",spend_sub_category:"",budget_cost:0}),className:"px-3 py-2 border border-gray-300 rounded-md",children:[(0,a.jsx)("option",{value:"",children:"Select cost line"}),tr.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]}),(0,a.jsxs)("select",{value:(null==k?void 0:k.spend_type)||"",onChange:t=>E(k?{...k,spend_type:t.target.value}:{project_id:e.id,sub_business_line:e.sub_business_line,cost_line:"",spend_type:t.target.value,spend_sub_category:"",budget_cost:0}),className:"px-3 py-2 border border-gray-300 rounded-md",children:[(0,a.jsx)("option",{value:"",children:"Select spend type"}),tn.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]}),(0,a.jsx)("input",{type:"text",placeholder:"Sub Category",value:(null==k?void 0:k.spend_sub_category)||"",onChange:t=>E(k?{...k,spend_sub_category:t.target.value}:{project_id:e.id,sub_business_line:e.sub_business_line,cost_line:"",spend_type:"",spend_sub_category:t.target.value,budget_cost:0}),className:"px-3 py-2 border border-gray-300 rounded-md"}),(0,a.jsx)("input",{type:"number",placeholder:"Budget Cost",value:(null==k?void 0:k.budget_cost)||"",onChange:t=>E(k?{...k,budget_cost:Number(t.target.value)}:{project_id:e.id,sub_business_line:e.sub_business_line,cost_line:"",spend_type:"",spend_sub_category:"",budget_cost:Number(t.target.value)}),className:"px-3 py-2 border border-gray-300 rounded-md"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{onClick:()=>{k&&(to(k),S(null),E(null))},disabled:D||!(null==k?void 0:k.cost_line)||!(null==k?void 0:k.spend_type)||!(null==k?void 0:k.spend_sub_category),className:"bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 disabled:opacity-50 transition-colors",children:D?"Adding...":"Add Entry"}),(0,a.jsx)("button",{onClick:()=>{S(null),E(null)},className:"bg-gray-500 text-white px-3 py-2 rounded-md hover:bg-gray-600 transition-colors",children:"Cancel"})]})]}):(0,a.jsx)("button",{onClick:()=>S(e.id),className:"px-4 py-2 rounded-lg transition-colors ".concat(I===e.id?"bg-orange-600 text-white hover:bg-orange-700":"bg-blue-600 text-white hover:bg-blue-700"),children:"Add New Entry"})})]})]})]})},e.id)})}),eC&&ek&&(()=>{let e=o.find(e=>e.id===eC),t=eD[ek.v1]||[],s=eD[ek.v2]||[],r=eD.originalItems||[],n=new Set,i=new Map;t.forEach(e=>{n.add(e.cost_breakdown_id)}),s.forEach(e=>{n.add(e.cost_breakdown_id)}),r.length>0?r.forEach(e=>{if(n.has(e.id)){let t=e.spend_sub_category||e.cost_line||"Unknown";e.cost_line&&e.spend_sub_category&&e.cost_line!==e.spend_sub_category&&(t="".concat(e.cost_line," - ").concat(e.spend_sub_category)),i.set(e.id,{id:e.id,name:t})}}):(m[eC]||[]).forEach(e=>{if(n.has(e.id)){let t=e.spend_sub_category||e.cost_line||"Unknown";e.cost_line&&e.spend_sub_category&&e.cost_line!==e.spend_sub_category&&(t="".concat(e.cost_line," - ").concat(e.spend_sub_category)),i.set(e.id,{id:e.id,name:t})}});let l=Array.from(n).map(e=>{let s=t.find(t=>t.cost_breakdown_id===e),a=i.get(e);return{costLineName:(null==a?void 0:a.name)||"Unknown",totalCost:s&&s.forecasted_cost||0}}),c=l.reduce((e,t)=>e+t.totalCost,0),d=Array.from(n).map(e=>{let t=s.find(t=>t.cost_breakdown_id===e),a=i.get(e);return{costLineName:(null==a?void 0:a.name)||"Unknown",totalCost:t&&t.forecasted_cost||0}}),u=d.reduce((e,t)=>e+t.totalCost,0);console.log("[Version Comparison] Data transformation:",{v1:ek.v1,v2:ek.v2,v1ForecastCount:t.length,v2ForecastCount:s.length,v1Total:c,v2Total:u,costItemCount:n.size,originalItemsCount:r.length,costItemMapEntries:Array.from(i.entries()).map(e=>{let[t,s]=e;return{id:t.substring(0,8)+"...",name:s.name}}),v1Items:l.filter(e=>e.totalCost>0).map(e=>({name:e.costLineName,cost:e.totalCost})),v2Items:d.filter(e=>e.totalCost>0).map(e=>({name:e.costLineName,cost:e.totalCost}))});let x=[{version:ek.v1,totalCost:c,costLines:l},{version:ek.v2,totalCost:u,costLines:d}];return(0,a.jsx)(e1,{isOpen:!0,onClose:()=>{eS(null),eE(null),eP({})},projectData:{id:eC,name:(null==e?void 0:e.name)||""},versions:x,mode:"sheet",showAdvancedFeatures:!1})})(),ev&&(0,a.jsx)(et,{isOpen:!0,onClose:()=>{ej(null),Z(null),L({}),T("")},projectId:ev,projectName:(null===(e=o.find(e=>e.id===ev))||void 0===e?void 0:e.name)||"",currentCosts:m[ev]||[],stagedEntries:ex[ev]||[],onSave:async(e,t,s)=>{await eX(ev,s,e,t),ej(null)},onAddEntry:e=>{to(e)},onUpdateEntry:e=>{e$(e)},onDeleteEntry:e=>{tc(e)}}),Array.from(d).map(e=>ef[e]>0&&(0,a.jsx)(b,{count:ef[e],onSave:()=>tg(e),onDiscard:()=>tp(e)},"unsaved-".concat(e))),ey.size>0&&(0,a.jsx)("div",{className:"fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white shadow-lg rounded-lg p-4 border border-gray-200 z-50",children:(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsxs)("span",{className:"font-medium",children:[ey.size," items selected"]}),(0,a.jsx)(f.z,{onClick:()=>{let e=Array.from(d)[0];e&&tf(e)},variant:"destructive",size:"sm",children:"Delete Selected"}),(0,a.jsx)(f.z,{onClick:()=>eN(new Set),variant:"outline",size:"sm",children:"Clear Selection"})]})})]})}},90033:function(e,t,s){"use strict";s.d(t,{Cd:function(){return o},X:function(){return c},bZ:function(){return l}});var a=s(2562);s(53121);var r=s(89940),n=s(71202);let i=(0,r.j)("relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",{variants:{variant:{default:"bg-card text-card-foreground",destructive:"text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90"}},defaultVariants:{variant:"default"}});function l(e){let{className:t,variant:s,...r}=e;return(0,a.jsx)("div",{"data-slot":"alert",role:"alert",className:(0,n.cn)(i({variant:s}),t),...r})}function o(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"alert-title",className:(0,n.cn)("col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",t),...s})}function c(e){let{className:t,...s}=e;return(0,a.jsx)("div",{"data-slot":"alert-description",className:(0,n.cn)("text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",t),...s})}},56092:function(e,t,s){"use strict";s.d(t,{E:function(){return i}});var a=s(2562);s(53121);var r=s(90876),n=s(71202);function i(e){let{className:t,value:s,...i}=e;return(0,a.jsx)(r.fC,{"data-slot":"progress",className:(0,n.cn)("bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",t),...i,children:(0,a.jsx)(r.z$,{"data-slot":"progress-indicator",className:"bg-primary h-full w-full flex-1 transition-all",style:{transform:"translateX(-".concat(100-(s||0),"%)")}})})}},40814:function(e,t,s){"use strict";s.d(t,{pm:function(){return m}});var a=s(53121);let r=0,n=new Map,i=e=>{if(n.has(e))return;let t=setTimeout(()=>{n.delete(e),d({type:"REMOVE_TOAST",toastId:e})},1e6);n.set(e,t)},l=(e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:s}=t;return s?i(s):e.toasts.forEach(e=>{i(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===s||void 0===s?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}},o=[],c={toasts:[]};function d(e){c=l(c,e),o.forEach(e=>{e(c)})}function u(e){let{...t}=e,s=(r=(r+1)%Number.MAX_SAFE_INTEGER).toString(),a=()=>d({type:"DISMISS_TOAST",toastId:s});return d({type:"ADD_TOAST",toast:{...t,id:s,open:!0,onOpenChange:e=>{e||a()}}}),{id:s,dismiss:a,update:e=>d({type:"UPDATE_TOAST",toast:{...e,id:s}})}}function m(){let[e,t]=a.useState(c);return a.useEffect(()=>(o.push(t),()=>{let e=o.indexOf(t);e>-1&&o.splice(e,1)}),[e]),{...e,toast:u,dismiss:e=>d({type:"DISMISS_TOAST",toastId:e})}}}},function(e){e.O(0,[197,22,623,316,813,307,339,811,208,945,744],function(){return e(e.s=94139)}),_N_E=e.O()}]);