# Story 1.2.1: KPICard Cleanup

## Status
Pending

## Story
**As a** development team,
**I want** to align Story 1.2 implementation with the finalized Living Blueprint Architecture principles,
**so that** the codebase maintains absolute leanness and serves as the correct pattern for all future Cell migrations.

## Acceptance Criteria
1. Directory renamed to `kpi-card/` (no v2 suffix)
2. Manifest ID updated to `kpi-card` (no v2)
3. Feature flag removed from all files
4. Old component deleted from `components/dashboard/kpi-card.tsx`
5. Dashboard page uses Cell directly (no conditional rendering)
6. All tests pass after cleanup
7. Ledger updated with cleanup entry
8. No references to "v2" or feature flags remain (verified via grep)

## Tasks / Subtasks

- [ ] Task 1: Rename Cell directory (AC: 1)
  - [ ] Rename `apps/web/components/cells/kpi-card-v2/` to `apps/web/components/cells/kpi-card/`
  - [ ] Verify all files moved correctly

- [ ] Task 2: Update Cell manifest (AC: 2)
  - [ ] Edit `apps/web/components/cells/kpi-card/manifest.json`
  - [ ] Change `"id": "kpi-card-v2"` to `"id": "kpi-card"`
  - [ ] Verify manifest validates with cell-validator

- [ ] Task 3: Remove feature flag logic (AC: 3, 5)
  - [ ] Edit `apps/web/app/projects/[id]/dashboard/page.tsx`
  - [ ] Remove `FEATURE_KPI_CARD_V2` constant
  - [ ] Remove conditional rendering (use Cell directly)
  - [ ] Update import: `import { KPICard } from '@/components/cells/kpi-card/component'`
  - [ ] Verify page still renders correctly

- [ ] Task 4: Delete old component (AC: 4)
  - [ ] Delete `apps/web/components/dashboard/kpi-card.tsx`
  - [ ] Verify file deleted

- [ ] Task 5: Remove feature flag environment variables (AC: 8)
  - [ ] Remove `NEXT_PUBLIC_FEATURE_KPI_CARD_V2` from `.env.example`
  - [ ] Remove `NEXT_PUBLIC_FEATURE_KPI_CARD_V2` from `.env.local`

- [ ] Task 6: Verify no references remain (AC: 8)
  - [ ] Run: `grep -r "kpi-card-v2" apps/web/` (should return nothing)
  - [ ] Run: `grep -r "FEATURE_KPI_CARD_V2" apps/web/` (should return nothing)
  - [ ] Run: `grep -r "components/dashboard/kpi-card" apps/web/` (should return nothing)
  - [ ] Document grep results

- [ ] Task 7: Update ledger (AC: 7)
  - [ ] Update existing Story 1.2 ledger entry: change `"id": "kpi-card-v2"` to `"id": "kpi-card"`
  - [ ] Create new ledger entry for Story 1.2.1 documenting cleanup:
    - Iteration ID: `iter_YYYYMMDD_HHMMSS_cleanupKPICard`
    - Artifacts modified: `kpi-card` (renamed from v2)
    - Artifacts replaced: old dashboard kpi-card deleted
    - Reason: "Align with finalized architecture: remove versioning and feature flags"

- [ ] Task 8: Test and commit (AC: 6)
  - [ ] Run all tests: `pnpm test`
  - [ ] Run build: `pnpm build`
  - [ ] Test manually: `pnpm dev` and verify dashboard works
  - [ ] Commit with message: "Story 1.2.1: KPICard cleanup - remove versioning and feature flags"

## Dev Notes

### Background Context

Story 1.2 (KPICard Pilot Cell) was implemented **before architecture finalization** using an earlier approach that included:
- ❌ Version suffix: `kpi-card-v2/` directory
- ❌ Feature flag: `NEXT_PUBLIC_FEATURE_KPI_CARD_V2`
- ❌ Parallel implementations: Both old and new components coexist
- ❌ Conditional rendering based on feature flag

The finalized Living Blueprint Architecture requires:
- ✅ Clean names: `kpi-card/` (no version suffixes)
- ✅ No feature flags: Direct replacement only
- ✅ Single implementation: Old component deleted
- ✅ Lean codebase: Optimized for AI agent clarity

This cleanup story removes all vestiges of the OLD approach and establishes the correct pattern for Story 1.3 and beyond.

### Relevant Source Tree

```
apps/web/
├── components/
│   ├── cells/
│   │   └── kpi-card-v2/          # TO BE RENAMED: kpi-card/
│   │       ├── component.tsx
│   │       ├── state.ts
│   │       ├── manifest.json     # ID needs update
│   │       └── pipeline.yaml
│   └── dashboard/
│       └── kpi-card.tsx          # TO BE DELETED
├── app/
│   └── projects/[id]/dashboard/
│       └── page.tsx              # Contains feature flag logic to remove
└── .env.example                  # Contains NEXT_PUBLIC_FEATURE_KPI_CARD_V2
```

### Why This Cleanup Matters

**For AI Agent Optimization:**
- Agents query ledger for "kpi-card" and get ONE result (not kpi-card vs kpi-card-v2)
- No conditional logic to parse (feature flags confuse agents)
- Clear, unambiguous component names
- Single source of truth per feature

**For 100% Architecture Adoption:**
- This establishes the CORRECT pattern for all future stories
- Story 1.3 (PLCommandCenter) must follow this pattern from the start
- Every future epic must follow this pattern
- The goal is complete refactor, not hybrid coexistence

**For Codebase Leanness:**
- Eliminates dead code (old component)
- Eliminates versioning complexity
- Reduces cognitive overhead
- Faster navigation and search

### Critical Success Factor

This story validates that the cleanup workflow works correctly. If successful, all future Cell migration stories will follow this exact pattern:
1. Create Cell with clean name (no v2)
2. Update imports
3. Delete old component in SAME story
4. Commit with only new Cell

### Estimated Duration
2-3 hours

### Testing

**Test File Locations:**
- Unit tests: `apps/web/components/cells/kpi-card/__tests__/component.test.tsx`
- Integration tests: `apps/web/__tests__/dashboard.test.tsx`
- E2E tests: `apps/web/__tests__/e2e/dashboard.spec.ts`

**Testing Requirements:**
- All existing KPI card tests must pass after renaming
- Verify no regressions in dashboard functionality
- Run full test suite: `pnpm test`
- Run build to ensure no TypeScript errors: `pnpm build`
- Manual browser testing: `pnpm dev` and verify dashboard renders correctly

**Testing Frameworks:**
- Unit/Integration: Vitest
- E2E: Playwright
- Type checking: TypeScript compiler (tsc)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-01 | 1.0 | Initial story creation for architecture alignment | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes List
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results

### Validation Checklist
- [ ] No files or directories with "v2" suffix
- [ ] No environment variables with "FEATURE_" prefix
- [ ] No conditional rendering in dashboard page
- [ ] Old component completely removed
- [ ] All tests pass (unit + integration + e2e)
- [ ] Manual testing confirms functionality unchanged
- [ ] Ledger updated with cleanup entry
- [ ] Grep verification shows zero references

### Expected Outcome
After this story, the codebase should contain:
- ✅ ONE KPI card implementation at `components/cells/kpi-card/`
- ✅ Clean manifest with ID: `kpi-card`
- ✅ Direct Cell usage (no feature flags)
- ✅ Zero references to old implementation
- ✅ Pattern established for Story 1.3+

### QA Review
_To be populated by QA agent after story completion_
